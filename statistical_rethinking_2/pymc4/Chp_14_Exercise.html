<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exercise 14M1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Chp_14_Exercise_files/libs/clipboard/clipboard.min.js"></script>
<script src="Chp_14_Exercise_files/libs/quarto-html/quarto.js"></script>
<script src="Chp_14_Exercise_files/libs/quarto-html/popper.min.js"></script>
<script src="Chp_14_Exercise_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Chp_14_Exercise_files/libs/quarto-html/anchor.min.js"></script>
<link href="Chp_14_Exercise_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Chp_14_Exercise_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Chp_14_Exercise_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Chp_14_Exercise_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Chp_14_Exercise_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exercise 14M1</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aesara <span class="im">import</span> tensor <span class="im">as</span> at</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Ellipse, transforms</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">"ignore"</span>, category<span class="op">=</span>(<span class="pp">FutureWarning</span>, <span class="pp">UserWarning</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>RANDOM_SEED <span class="op">=</span> <span class="dv">8927</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(RANDOM_SEED)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-darkgrid"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>az.rcParams[<span class="st">"stats.hdi_prob"</span>] <span class="op">=</span> <span class="fl">0.89</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>az.rcParams[<span class="st">"stats.ic_scale"</span>] <span class="op">=</span> <span class="st">"deviance"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>az.rcParams[<span class="st">"stats.information_criterion"</span>] <span class="op">=</span> <span class="st">"waic"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize(series):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Standardize a pandas series"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (series <span class="op">-</span> series.mean()) <span class="op">/</span> series.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Repeat the café robot simulation from the beginning of the chapter. This time, set rho to zero, so that there is no correlation between intercepts and slopes. How does the posterior distribution of the correlation reflect this change in the underlying simulation?</p>
<hr>
<p>Simulate again a population of cafes</p>
<div class="cell" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">3.5</span>  <span class="co"># average morning wait time</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span>  <span class="co"># average difference afternoon wait time</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>sigma_a <span class="op">=</span> <span class="fl">1.0</span>  <span class="co"># std dev in intercepts</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>sigma_b <span class="op">=</span> <span class="fl">0.5</span>  <span class="co"># std dev in slopes</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>rho <span class="op">=</span> <span class="dv">0</span>  <span class="co"># correlation between intercepts and slopes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>Mu <span class="op">=</span> [a, b]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remember how you can build the Sigma matrix in different ways</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cov_ab <span class="op">=</span> sigma_a <span class="op">*</span> sigma_b <span class="op">*</span> rho</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Sigma <span class="op">=</span> np.array([[sigma_a<span class="op">**</span><span class="dv">2</span>, cov_ab], [cov_ab, sigma_b<span class="op">**</span><span class="dv">2</span>]])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>Sigma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[1.  , 0.  ],
       [0.  , 0.25]])</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sigmas <span class="op">=</span> [sigma_a, sigma_b]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Rho <span class="op">=</span> np.matrix([[<span class="dv">1</span>, rho], [rho, <span class="dv">1</span>]])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>Sigma <span class="op">=</span> np.diag(sigmas) <span class="op">*</span> Rho <span class="op">*</span> np.diag(sigmas)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>Sigma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>matrix([[1.  , 0.  ],
        [0.  , 0.25]])</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>N_cafes <span class="op">=</span> <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>vary_effects <span class="op">=</span> np.random.multivariate_normal(mean<span class="op">=</span>Mu, cov<span class="op">=</span>Sigma, size<span class="op">=</span>N_cafes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>a_cafe <span class="op">=</span> vary_effects[:, <span class="dv">0</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>b_cafe <span class="op">=</span> vary_effects[:, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Gauss2d(mu, cov, ci, ax<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Copied from statsmodel"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        _, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    v_, w <span class="op">=</span> np.linalg.eigh(cov) <span class="co">#eigenvalues and eigenvectors</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> w[<span class="dv">0</span>] <span class="op">/</span> np.linalg.norm(w[<span class="dv">0</span>])</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    angle <span class="op">=</span> np.arctan(u[<span class="dv">1</span>] <span class="op">/</span> u[<span class="dv">0</span>])</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    angle <span class="op">=</span> <span class="dv">180</span> <span class="op">*</span> angle <span class="op">/</span> np.pi  <span class="co"># convert to degrees</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> level <span class="kw">in</span> ci:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.sqrt(v_ <span class="op">*</span> stats.chi2.ppf(level, <span class="dv">2</span>))  <span class="co"># get size corresponding to level</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        ell <span class="op">=</span> Ellipse( </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            mu[:<span class="dv">2</span>],</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>            v[<span class="dv">0</span>],</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            v[<span class="dv">1</span>],</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>            angle <span class="op">=</span> <span class="dv">180</span> <span class="op">+</span> angle,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            facecolor<span class="op">=</span><span class="st">"None"</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span> <span class="op">-</span> level,<span class="fl">.1</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            lw<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        ell.set_clip_box(ax.bbox)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ell.set_alpha(0.5)</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        ax.add_artist(ell)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>plotting intercepts and slopes. The relationship higlights how cafes with long waiting times (large a’s) usually have a lot of improvement in the afternoon (a shorter waiting time). Correlation in the a and b parameters is lost now.</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> Gauss2d(Mu, np.asarray(Sigma), [<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.99</span>])</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(a_cafe, b_cafe, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="op">-</span><span class="fl">0.5</span>, <span class="dv">7</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="op">-</span><span class="fl">2.6</span>, <span class="fl">0.6</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"intercepts (a_cafe)"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"slopes (b_cafe)"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/scratch/28243578/ipykernel_864972/2330047673.py:8: RuntimeWarning: divide by zero encountered in double_scalars
  angle = np.arctan(u[1] / u[0])</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-13-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Above were simulations of cafes and the full description of their properties (through simulated intercepts and slopes). Below we simulate visits to cafes.</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>N_visits <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>afternoon <span class="op">=</span> np.tile([<span class="dv">0</span>, <span class="dv">1</span>], N_visits <span class="op">*</span> N_cafes <span class="op">//</span> <span class="dv">2</span>)  <span class="co"># wrap with int() to suppress warnings</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>cafe_id <span class="op">=</span> np.repeat(np.arange(<span class="dv">0</span>, N_cafes), N_visits)  <span class="co"># 1-20 (minus 1 for python indexing)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> a_cafe[cafe_id] <span class="op">+</span> b_cafe[cafe_id] <span class="op">*</span> afternoon</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.5</span>  <span class="co"># std dev within cafes</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>wait <span class="op">=</span> np.random.normal(loc<span class="op">=</span>mu, scale<span class="op">=</span>sigma, size<span class="op">=</span>N_visits <span class="op">*</span> N_cafes)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> pd.DataFrame(<span class="bu">dict</span>(cafe<span class="op">=</span>cafe_id, afternoon<span class="op">=</span>afternoon, wait<span class="op">=</span>wait))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cafe</th>
<th data-quarto-table-cell-role="th">afternoon</th>
<th data-quarto-table-cell-role="th">wait</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>2.824015</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>1.804069</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>2.893324</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>1</td>
<td>0.935652</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>4.149596</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">195</td>
<td>19</td>
<td>1</td>
<td>1.868736</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">196</td>
<td>19</td>
<td>0</td>
<td>3.666390</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">197</td>
<td>19</td>
<td>1</td>
<td>1.158664</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">198</td>
<td>19</td>
<td>0</td>
<td>3.352406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">199</td>
<td>19</td>
<td>1</td>
<td>1.512274</td>
</tr>
</tbody>
</table>

<p>200 rows × 3 columns</p>
</div>
</div>
</div>
<p>Building the model</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cafe_idx <span class="op">=</span> d[<span class="st">"cafe"</span>].values</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_1:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LKJCholeskyCov is more efficient than LKJCorr</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PyMC &gt;= 3.9 extracts the stds and matrix of correlations automatically for us</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the distribution of standard deviations is included as an option because the</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># functions also calculates correlation within cafes to output the matrix</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    chol, Rho_, sigma_cafe <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_cov"</span>, n<span class="op">=</span><span class="dv">2</span>, eta<span class="op">=</span><span class="dv">2</span>, sd_dist<span class="op">=</span>pm.Exponential.dist(<span class="fl">1.0</span>), compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Normal(<span class="st">"a"</span>, <span class="fl">5.0</span>, <span class="fl">2.0</span>)  <span class="co"># prior for average intercept</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> pm.Normal(<span class="st">"b"</span>, <span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.5</span>)  <span class="co"># prior for average slope</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    ab_cafe <span class="op">=</span> pm.MvNormal(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ab_cafe"</span>, mu<span class="op">=</span>at.stack([a, b]), chol<span class="op">=</span>chol, shape<span class="op">=</span>(N_cafes, <span class="dv">2</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># population of varying effects</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># shape needs to be (N_cafes, 2) because we're getting back both a and b for each cafe</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> ab_cafe[cafe_idx, <span class="dv">0</span>] <span class="op">+</span> ab_cafe[cafe_idx, <span class="dv">1</span>] <span class="op">*</span> d[<span class="st">"afternoon"</span>].values  <span class="co"># linear model</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    sigma_within <span class="op">=</span> pm.Exponential(<span class="st">"sigma_within"</span>, <span class="fl">1.0</span>)  <span class="co"># prior stddev within cafes</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    wait <span class="op">=</span> pm.Normal(<span class="st">"wait"</span>, mu<span class="op">=</span>mu, sigma<span class="op">=</span>sigma_within, observed<span class="op">=</span>d[<span class="st">"wait"</span>].values)  <span class="co"># likelihood</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14m1.nc'</span>)):</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        trace_14m1 <span class="op">=</span> pm.sample(<span class="dv">4000</span>, tune<span class="op">=</span><span class="dv">4000</span>, target_accept<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        trace_14m1.rename({<span class="st">"chol_cov_corr"</span>: <span class="st">"Rho"</span>, <span class="st">"chol_cov_stds"</span>: <span class="st">"sigma_cafe"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14m1, <span class="st">'trace_14m1.nc'</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [chol_cov, a, b, ab_cafe, sigma_within]
Sampling 4 chains for 4_000 tune and 4_000 draw iterations (16_000 + 16_000 draws total) took 443 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="32000" class="" max="32000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [32000/32000 07:20&lt;00:00 Sampling 4 chains, 4 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#az.InferenceData.to_netcdf(trace_14_1, 'trace_14_1.nc')</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>trace_14m1 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14m1.nc'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>post <span class="op">=</span> trace_14m1.posterior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For complex models it is always good to do more checks:</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14m1, var_names<span class="op">=</span>[<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"sigma_within"</span>, <span class="st">"Rho"</span>, <span class="st">"sigma_cafe"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/faststorage/project/sandbox_scrna_course/Repo/bayesian_statistics/statistical_rethinking_2/pymc4/pymc4_env2/lib/python3.10/site-packages/arviz/stats/diagnostics.py:584: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">a</td>
<td>3.72</td>
<td>0.18</td>
<td>3.43</td>
<td>4.01</td>
<td>0.0</td>
<td>0.0</td>
<td>19410.95</td>
<td>12603.63</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">b</td>
<td>-1.08</td>
<td>0.13</td>
<td>-1.29</td>
<td>-0.88</td>
<td>0.0</td>
<td>0.0</td>
<td>15477.91</td>
<td>13254.33</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_within</td>
<td>0.55</td>
<td>0.03</td>
<td>0.50</td>
<td>0.60</td>
<td>0.0</td>
<td>0.0</td>
<td>17598.61</td>
<td>12506.80</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[0, 0]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>16000.00</td>
<td>16000.00</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[0, 1]</td>
<td>0.16</td>
<td>0.26</td>
<td>-0.23</td>
<td>0.61</td>
<td>0.0</td>
<td>0.0</td>
<td>9679.39</td>
<td>9691.82</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[1, 0]</td>
<td>0.16</td>
<td>0.26</td>
<td>-0.23</td>
<td>0.61</td>
<td>0.0</td>
<td>0.0</td>
<td>9679.39</td>
<td>9691.82</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[1, 1]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>15725.60</td>
<td>15581.43</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_cafe[0]</td>
<td>0.77</td>
<td>0.14</td>
<td>0.55</td>
<td>0.98</td>
<td>0.0</td>
<td>0.0</td>
<td>17796.39</td>
<td>12746.37</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_cafe[1]</td>
<td>0.46</td>
<td>0.13</td>
<td>0.26</td>
<td>0.66</td>
<td>0.0</td>
<td>0.0</td>
<td>5181.51</td>
<td>5167.68</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    trace_14m1,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    compact<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">"~ab_cafe"</span>, <span class="st">"~chol_cov"</span>],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    coords<span class="op">=</span>{<span class="st">"chol_cov_corr_dim_0"</span>: <span class="dv">1</span>, <span class="co">#Takes second element of first row in correlation matrix</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_cov_corr_dim_1"</span>: <span class="dv">0</span>}, <span class="co">#Takes first element of second row in correlation matrix</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    lines<span class="op">=</span>[</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"a"</span>, {}, Mu[<span class="dv">0</span>]),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"b"</span>, {}, Mu[<span class="dv">1</span>]),</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"sigma_cafe"</span>, {}, sigmas),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Rho"</span>, {}, Rho[<span class="dv">0</span>, <span class="dv">1</span>]),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"sigma_within"</span>, {}, sigma),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Prior and posterior for the correlation coefficient, inferred only from the waiting times resulting from the model of cafe’s!!!</p>
<div class="cell" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> pm.LKJCorr.dist(n<span class="op">=</span><span class="dv">2</span>, eta<span class="op">=</span><span class="dv">2</span>, size<span class="op">=</span><span class="dv">10000</span>).<span class="bu">eval</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>az.plot_kde(R, plot_kwargs<span class="op">=</span>{<span class="st">"color"</span>: <span class="st">"k"</span>, <span class="st">"linestyle"</span>: <span class="st">"--"</span>})</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="st">"prior"</span>, horizontalalignment<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>az.plot_kde(</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    np.array(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        az.extract_dataset(post[<span class="st">"Rho"</span>].sel(chol_cov_corr_dim_0<span class="op">=</span><span class="dv">1</span>, chol_cov_corr_dim_1<span class="op">=</span><span class="dv">0</span>)).to_array()</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    plot_kwargs<span class="op">=</span>{<span class="st">"color"</span>: <span class="st">"C0"</span>},</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">1.5</span>, <span class="st">"posterior"</span>, color<span class="op">=</span><span class="st">"C0"</span>, horizontalalignment<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"correlation"</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Density"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute unpooled estimates directly from data</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>a1b1 <span class="op">=</span> d.groupby([<span class="st">"afternoon"</span>, <span class="st">"cafe"</span>]).agg(<span class="st">"mean"</span>).unstack(level<span class="op">=</span><span class="dv">0</span>).values</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>a1 <span class="op">=</span> a1b1[:, <span class="dv">0</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> a1b1[:, <span class="dv">1</span>] <span class="op">-</span> a1 <span class="co"># in the afternoon data generated you have the sum of a and b, so you need only b</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># extract posterior means of partially pooled estimates</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>a2b2 <span class="op">=</span> post[<span class="st">"ab_cafe"</span>].mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>a2 <span class="op">=</span> a2b2[:, <span class="dv">0</span>]</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> a2b2[:, <span class="dv">1</span>]</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># compute posterior mean bivariate Gaussian</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>ab <span class="op">=</span> post[[<span class="st">"a"</span>, <span class="st">"b"</span>]].mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>Mu_est <span class="op">=</span> np.array([ab[<span class="st">"a"</span>], ab[<span class="st">"b"</span>]])</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>chol_model <span class="op">=</span> pm.expand_packed_triangular(</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>, post[<span class="st">"chol_cov"</span>].mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)).to_numpy(), lower<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>).<span class="bu">eval</span>()</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>Sigma_est <span class="op">=</span> np.dot(chol_model, chol_model.T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># draw contours</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> Gauss2d(mu<span class="op">=</span>Mu_est, cov<span class="op">=</span>np.asarray(Sigma_est), ci<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.99</span>], ax<span class="op">=</span>ax)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both and connect with lines</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>ax.scatter(a1, b1, label<span class="op">=</span><span class="st">"unpooled"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ax.scatter(a2, b2, label<span class="op">=</span><span class="st">"varying eff."</span>, facecolors<span class="op">=</span><span class="st">"none"</span>, edgecolors<span class="op">=</span><span class="st">"k"</span>, lw<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ax.plot([a1, a2], [b1, b2], <span class="st">"k-"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"intercept"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"slope"</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="fl">0.5</span>, <span class="fl">6.1</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="op">-</span><span class="fl">2.5</span>, <span class="fl">0.6</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert varying effects to waiting times</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>wait_morning_1 <span class="op">=</span> a1</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>wait_afternoon_1 <span class="op">=</span> a1 <span class="op">+</span> b1</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>wait_morning_2 <span class="op">=</span> a2</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>wait_afternoon_2 <span class="op">=</span> a2 <span class="op">+</span> b2</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># now shrinkage distribution by simulation</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> np.random.multivariate_normal(mean<span class="op">=</span>Mu_est, cov<span class="op">=</span>Sigma_est, size<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>v[:, <span class="dv">1</span>] <span class="op">=</span> v[:, <span class="dv">0</span>] <span class="op">+</span> v[:, <span class="dv">1</span>]  <span class="co"># calculate afternoon wait</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>Sigma_est2 <span class="op">=</span> np.cov(v.T)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>Mu_est2 <span class="op">=</span> Mu_est.copy()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>Mu_est2[<span class="dv">1</span>] <span class="op">=</span> Mu_est[<span class="dv">0</span>] <span class="op">+</span> Mu_est[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># draw contours</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> Gauss2d(mu<span class="op">=</span>Mu_est2, cov<span class="op">=</span>np.asarray(Sigma_est2), ci<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.99</span>], ax<span class="op">=</span>ax)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both and connect with lines</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>ax.scatter(wait_morning_1, wait_afternoon_1, label<span class="op">=</span><span class="st">"unpooled"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>ax.scatter(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    wait_morning_2,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    wait_afternoon_2,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"varying eff."</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    facecolors<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    edgecolors<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    lw<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    [wait_morning_1, wait_morning_2],</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    [wait_afternoon_1, wait_afternoon_2],</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k-"</span>,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>ax.plot(<span class="bu">range</span>(<span class="dv">6</span>), <span class="bu">range</span>(<span class="dv">6</span>), <span class="st">"k--"</span>, label<span class="op">=</span><span class="st">"equal wait time"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"morning wait"</span>)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"afternoon wait"</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="op">-</span><span class="fl">0.2</span>, <span class="dv">6</span>)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="op">-</span><span class="fl">0.2</span>, <span class="dv">5</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">9</span>, ncol<span class="op">=</span><span class="dv">2</span>, loc<span class="op">=</span><span class="st">"upper left"</span>, frameon<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="advanced-varying-slopes" class="level2">
<h2 class="anchored" data-anchor-id="advanced-varying-slopes">Advanced Varying Slopes</h2>
<p>From the chimpanzee experiment. Now we want to have pooling across actors and across experimental blocks. The indexing is done also across the various treatments, since we want to model each of the fours treatments (prosocial or not, left or right = 4 treatments in total).</p>
<section id="code-14.18" class="level4">
<h4 class="anchored" data-anchor-id="code-14.18">Code 14.18</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:41.011256Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:41.010576Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:41.029568Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:41.028699Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:41.011200Z&quot;}" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> pd.read_csv(<span class="st">"Data/chimpanzees.csv"</span>, sep<span class="op">=</span><span class="st">";"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>d[<span class="st">"treatment"</span>] <span class="op">=</span> d.prosoc_left <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> d.condition</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>tid_ <span class="op">=</span> d.treatment.values</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>Ntreatments <span class="op">=</span> <span class="bu">len</span>(np.unique(tid_))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>d[<span class="st">"actor"</span>] <span class="op">=</span> d.actor <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>actor_ <span class="op">=</span> d.actor.astype(<span class="bu">int</span>).values</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>Nactors <span class="op">=</span> <span class="bu">len</span>(np.unique(actor_))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>d[<span class="st">"block"</span>] <span class="op">=</span> d.block <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>block_id_ <span class="op">=</span> d.block.astype(<span class="bu">int</span>).values</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>Nblocks <span class="op">=</span> <span class="bu">len</span>(np.unique(block_id_))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:41.374320Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:41.373477Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:41.397072Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:41.396242Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:41.374264Z&quot;}" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>d.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">actor</th>
<th data-quarto-table-cell-role="th">recipient</th>
<th data-quarto-table-cell-role="th">condition</th>
<th data-quarto-table-cell-role="th">block</th>
<th data-quarto-table-cell-role="th">trial</th>
<th data-quarto-table-cell-role="th">prosoc_left</th>
<th data-quarto-table-cell-role="th">chose_prosoc</th>
<th data-quarto-table-cell-role="th">pulled_left</th>
<th data-quarto-table-cell-role="th">treatment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>8</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>10</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:41.970512Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:41.969842Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:56.069232Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:56.068368Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:41.970458Z&quot;}" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_2:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed priors</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> pm.Normal(<span class="st">"g"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, shape<span class="op">=</span>Ntreatments)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    sd_dist <span class="op">=</span> pm.Exponential.dist(<span class="fl">1.0</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    chol_actor, _, _ <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_actor"</span>, n<span class="op">=</span>Ntreatments, eta<span class="op">=</span><span class="dv">4</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    chol_block, _, _ <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_block"</span>, n<span class="op">=</span>Ntreatments, eta<span class="op">=</span><span class="dv">4</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adaptive priors</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.MvNormal(<span class="st">"alpha"</span>, mu<span class="op">=</span><span class="fl">0.0</span>, chol<span class="op">=</span>chol_actor, shape<span class="op">=</span>(Nactors, Ntreatments))</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.MvNormal(<span class="st">"beta"</span>, mu<span class="op">=</span><span class="fl">0.0</span>, chol<span class="op">=</span>chol_block, shape<span class="op">=</span>(Nblocks, Ntreatments))</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for posterior predictions</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    actor <span class="op">=</span> pm.Data(<span class="st">"actor"</span>, actor_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    block_id <span class="op">=</span> pm.Data(<span class="st">"block_id"</span>, block_id_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> pm.Data(<span class="st">"tid"</span>, tid_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> pm.math.invlogit(g[tid] <span class="op">+</span> alpha[actor, tid] <span class="op">+</span> beta[block_id, tid])</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    pulled_left <span class="op">=</span> pm.Binomial(<span class="st">"pulled_left"</span>, <span class="dv">1</span>, p, observed<span class="op">=</span>d.pulled_left)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_2.nc'</span>)):</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        trace_14_2 <span class="op">=</span> pm.sample(<span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        trace_14_2.rename(</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_actor_corr"</span>: <span class="st">"Rho_actor"</span>,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_actor_stds"</span>: <span class="st">"sigma_actor"</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_block_corr"</span>: <span class="st">"Rho_block"</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_block_stds"</span>: <span class="st">"sigma_block"</span>,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>            inplace<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_2, <span class="st">'trace_14_2.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.19" class="level4">
<h4 class="anchored" data-anchor-id="code-14.19">Code 14.19</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:56.071784Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:56.071299Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:56.241848Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:56.240204Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:56.071757Z&quot;}" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_3:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed priors</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> pm.Normal(<span class="st">"g"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, shape<span class="op">=</span>Ntreatments)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    sd_dist <span class="op">=</span> pm.Exponential.dist(<span class="fl">1.0</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    chol_actor, _, _ <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_actor"</span>, n<span class="op">=</span>Ntreatments, eta<span class="op">=</span><span class="dv">4</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    chol_block, _, _ <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_block"</span>, n<span class="op">=</span>Ntreatments, eta<span class="op">=</span><span class="dv">4</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adaptive priors non-centered</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    z_actor <span class="op">=</span> pm.Normal(<span class="st">"z_actor"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, shape<span class="op">=</span>(Ntreatments, Nactors))</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Deterministic(<span class="st">"alpha"</span>, pm.math.dot(chol_actor, z_actor))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    z_block <span class="op">=</span> pm.Normal(<span class="st">"z_block"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, shape<span class="op">=</span>(Ntreatments, Nblocks))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Deterministic(<span class="st">"beta"</span>, pm.math.dot(chol_block, z_block))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for posterior predictions</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    actor <span class="op">=</span> pm.Data(<span class="st">"actor"</span>, actor_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    block_id <span class="op">=</span> pm.Data(<span class="st">"block_id"</span>, block_id_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> pm.Data(<span class="st">"tid"</span>, tid_, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> pm.Deterministic(<span class="st">"p"</span>, pm.math.invlogit(g[tid] <span class="op">+</span> alpha[tid, actor] <span class="op">+</span> beta[tid, block_id]))</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    pulled_left <span class="op">=</span> pm.Binomial(<span class="st">"pulled_left"</span>, <span class="dv">1</span>, p, observed<span class="op">=</span>d.pulled_left)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_3.nc'</span>)):</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        trace_14_3 <span class="op">=</span> pm.sample(<span class="dv">4000</span>, tune<span class="op">=</span><span class="dv">4000</span>, target_accept<span class="op">=</span><span class="fl">0.9</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        trace_14_3.rename(</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_actor_corr"</span>: <span class="st">"Rho_actor"</span>,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_actor_stds"</span>: <span class="st">"sigma_actor"</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_block_corr"</span>: <span class="st">"Rho_block"</span>,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chol_block_stds"</span>: <span class="st">"sigma_block"</span>,</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            inplace<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_3, <span class="st">'trace_14_3.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:56.244562Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:56.244288Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:56.503589Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:56.502854Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:56.244530Z&quot;}" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>trace_14_2 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_2.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:56.507098Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:56.506555Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:56.661747Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:56.661009Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:56.507063Z&quot;}" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>trace_14_3 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_3.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.20" class="level4">
<h4 class="anchored" data-anchor-id="code-14.20">Code 14.20</h4>
<p>calculate diagnostic summaries for the centered and non-centered model. The non-centered one is going to be much more efficient (mean ess higher than in the centered model)</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:56.663417Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:56.662826Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:59.442320Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:59.441232Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:56.663386Z&quot;}" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>m_14_2 <span class="op">=</span> az.summary(trace_14_2, var_names<span class="op">=</span>[<span class="st">"alpha"</span>, <span class="st">"beta"</span>], kind<span class="op">=</span><span class="st">"diagnostics"</span>, round_to<span class="op">=</span><span class="dv">2</span>)[</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ess_bulk"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>m_14_2.name <span class="op">=</span> <span class="st">"m14_2"</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>m_14_3 <span class="op">=</span> az.summary(trace_14_3, var_names<span class="op">=</span>[<span class="st">"alpha"</span>, <span class="st">"beta"</span>], kind<span class="op">=</span><span class="st">"diagnostics"</span>, round_to<span class="op">=</span><span class="dv">2</span>)[</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ess_bulk"</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>m_14_3.name <span class="op">=</span> <span class="st">"m14_3"</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>ess_mean <span class="op">=</span> pd.concat([m_14_2, m_14_3], axis<span class="op">=</span><span class="dv">1</span>, sort<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:59.443750Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:59.443491Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:03:59.813663Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:03:59.812887Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:59.443726Z&quot;}" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plt.plot(ess_mean.m14_2.values, ess_mean.m14_3.values, <span class="st">"o"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> ess_mean.<span class="bu">max</span>().<span class="bu">max</span>()</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(max_val), np.arange(max_val), <span class="st">"k--"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"n_eff (centered)"</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"n_eff (non-centered)"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.21" class="level4">
<h4 class="anchored" data-anchor-id="code-14.21">Code 14.21</h4>
<p>The shrinking given by the pooling is quite strong. Here you can see it by looking at the small standard deviations of pooled actors and blocks.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:03:59.814905Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:03:59.814706Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:00.065070Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:00.064324Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:03:59.814887Z&quot;}" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_3, var_names<span class="op">=</span><span class="st">"sigma"</span>, filter_vars<span class="op">=</span><span class="st">"like"</span>, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_actor[0]</td>
<td>1.41</td>
<td>0.49</td>
<td>0.66</td>
<td>2.05</td>
<td>0.01</td>
<td>0.01</td>
<td>2424.02</td>
<td>9696.02</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_actor[1]</td>
<td>0.92</td>
<td>0.42</td>
<td>0.29</td>
<td>1.49</td>
<td>0.01</td>
<td>0.01</td>
<td>1714.37</td>
<td>4403.67</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_actor[2]</td>
<td>1.84</td>
<td>0.57</td>
<td>1.05</td>
<td>2.67</td>
<td>0.01</td>
<td>0.01</td>
<td>3097.14</td>
<td>5772.86</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_actor[3]</td>
<td>1.60</td>
<td>0.61</td>
<td>0.75</td>
<td>2.43</td>
<td>0.01</td>
<td>0.01</td>
<td>3546.57</td>
<td>7312.30</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_block[0]</td>
<td>0.39</td>
<td>0.32</td>
<td>0.00</td>
<td>0.79</td>
<td>0.01</td>
<td>0.00</td>
<td>1649.73</td>
<td>5389.00</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_block[1]</td>
<td>0.44</td>
<td>0.34</td>
<td>0.01</td>
<td>0.84</td>
<td>0.01</td>
<td>0.01</td>
<td>2590.80</td>
<td>2578.95</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_block[2]</td>
<td>0.29</td>
<td>0.27</td>
<td>0.00</td>
<td>0.61</td>
<td>0.01</td>
<td>0.01</td>
<td>546.24</td>
<td>226.35</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_block[3]</td>
<td>0.47</td>
<td>0.37</td>
<td>0.01</td>
<td>0.92</td>
<td>0.01</td>
<td>0.01</td>
<td>149.28</td>
<td>22.09</td>
<td>1.02</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.22" class="level4">
<h4 class="anchored" data-anchor-id="code-14.22">Code 14.22</h4>
<p>Plotting predictions and observed data. Note how not only the averages are important (the dots in the plot), but it is relevant to have a distribution of responses to understand which intervals the outcomes can cover.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:00.067063Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:00.066630Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:00.127757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:00.127020Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:00.067038Z&quot;}" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute mean for each actor in each treatment</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>pl <span class="op">=</span> d.groupby([<span class="st">"actor"</span>, <span class="st">"treatment"</span>]).agg(<span class="st">"mean"</span>)[<span class="st">"pulled_left"</span>].unstack()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>pl_val <span class="op">=</span> pl.stack().values</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>pl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">treatment</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">actor</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.333333</td>
<td>0.500000</td>
<td>0.277778</td>
<td>0.555556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.277778</td>
<td>0.611111</td>
<td>0.166667</td>
<td>0.333333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.333333</td>
<td>0.500000</td>
<td>0.111111</td>
<td>0.444444</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.333333</td>
<td>0.555556</td>
<td>0.277778</td>
<td>0.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.777778</td>
<td>0.611111</td>
<td>0.555556</td>
<td>0.611111</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.777778</td>
<td>0.833333</td>
<td>0.944444</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:00.129741Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:00.129279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:04.061183Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:04.060146Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:00.129714Z&quot;}" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate posterior predictions</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m14_3:</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    pm.set_data(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"actor"</span>: np.repeat(<span class="bu">range</span>(<span class="dv">7</span>), <span class="dv">4</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"block_id"</span>: np.repeat(<span class="dv">4</span>, <span class="dv">4</span> <span class="op">*</span> <span class="dv">7</span>),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tid"</span>: <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">4</span>)) <span class="op">*</span> <span class="dv">7</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    post_pred <span class="op">=</span> pm.sample_posterior_predictive(trace_14_3, random_seed<span class="op">=</span>RANDOM_SEED, var_names<span class="op">=</span><span class="st">"p"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    p_post <span class="op">=</span> post_pred[<span class="st">"posterior_predictive"</span>][<span class="st">"p"</span>]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>p_mu <span class="op">=</span> np.array(p_post.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>])).reshape((<span class="dv">7</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: []</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="16000" class="" max="16000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [16000/16000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:04.064692Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:04.064427Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:04.518108Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:04.517453Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:04.064668Z&quot;}" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up plot</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">4</span>), constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>alpha, xoff, yoff <span class="op">=</span> <span class="fl">0.6</span>, <span class="fl">0.3</span>, <span class="fl">0.06</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    [np.arange(<span class="dv">28</span>) <span class="op">+</span> xoff, np.arange(<span class="dv">28</span>) <span class="op">+</span> xoff],</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    np.array(az.hdi(p_post).to_array())[<span class="dv">0</span>].T,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k-"</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    lw<span class="op">=</span><span class="fl">1.2</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span>alpha,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>ax.plot([<span class="dv">7</span> <span class="op">*</span> <span class="dv">4</span> <span class="op">-</span> <span class="fl">0.5</span>] <span class="op">*</span> <span class="dv">2</span>, [<span class="dv">0</span>, <span class="dv">1</span>], c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="fl">0.5</span>, ls<span class="op">=</span><span class="st">"--"</span>, c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> actor <span class="kw">in</span> <span class="bu">range</span>(Nactors):</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># raw data</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span>, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span>],</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        [pl.loc[actor, <span class="dv">0</span>], pl.loc[actor, <span class="dv">2</span>]],</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-"</span>,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"b"</span>,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span>, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span>],</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        [pl.loc[actor, <span class="dv">1</span>], pl.loc[actor, <span class="dv">3</span>]],</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-"</span>,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"b"</span>,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span>, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span>],</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>        [pl.loc[actor, <span class="dv">0</span>], pl.loc[actor, <span class="dv">1</span>]],</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"o"</span>,</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"b"</span>,</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        fillstyle<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        ms<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span>, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span>],</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        [pl.loc[actor, <span class="dv">2</span>], pl.loc[actor, <span class="dv">3</span>]],</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"o"</span>,</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"b"</span>,</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>        ms<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># posterior predictions</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> xoff, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">+</span> xoff],</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>        [p_mu[actor, <span class="dv">0</span>], p_mu[actor, <span class="dv">2</span>]],</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-"</span>,</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> xoff, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">+</span> xoff],</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>        [p_mu[actor, <span class="dv">1</span>], p_mu[actor, <span class="dv">3</span>]],</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-"</span>,</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> xoff, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> xoff],</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>        [p_mu[actor, <span class="dv">0</span>], p_mu[actor, <span class="dv">1</span>]],</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"o"</span>,</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>        fillstyle<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>        ms<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>        [actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">+</span> xoff, actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">+</span> xoff],</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>        [p_mu[actor, <span class="dv">2</span>], p_mu[actor, <span class="dv">3</span>]],</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"o"</span>,</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>        ms<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>    ax.plot([actor <span class="op">*</span> <span class="dv">4</span> <span class="op">-</span> <span class="fl">0.5</span>] <span class="op">*</span> <span class="dv">2</span>, [<span class="dv">0</span>, <span class="dv">1</span>], c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>    ax.text(actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="fl">0.5</span>, <span class="fl">1.1</span>, <span class="ss">f"actor </span><span class="sc">{</span>actor <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> actor <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>        ax.text(actor <span class="op">*</span> <span class="dv">4</span> <span class="op">-</span> xoff, pl.loc[actor, <span class="dv">0</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> yoff, <span class="st">"R/N"</span>)</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>        ax.text(actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">-</span> xoff, pl.loc[actor, <span class="dv">1</span>] <span class="op">+</span> yoff, <span class="st">"L/N"</span>)</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>        ax.text(actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">-</span> xoff, pl.loc[actor, <span class="dv">2</span>] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> yoff, <span class="st">"R/P"</span>)</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>        ax.text(actor <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">-</span> xoff, pl.loc[actor, <span class="dv">3</span>] <span class="op">+</span> yoff, <span class="st">"L/P"</span>)</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>ax.set_xticks([])</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"proportion left lever"</span>, labelpad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"posterior predictions"</span>, pad<span class="op">=</span><span class="dv">25</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="instrumental-variables" class="level2">
<h2 class="anchored" data-anchor-id="instrumental-variables">Instrumental variables</h2>
<section id="code-14.23" class="level4">
<h4 class="anchored" data-anchor-id="code-14.23">Code 14.23</h4>
<p>A model with Q representing season of birth, influencing E (education) which influences W (wage). U is a confounder. For simplicity the effect of age is 0.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:04.519035Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:04.518838Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:04.530897Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:04.530078Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:04.519017Z&quot;}" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>U_sim <span class="op">=</span> np.random.normal(size<span class="op">=</span>N)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>Q_sim <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">5</span>, N)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>E_sim <span class="op">=</span> np.random.normal(loc<span class="op">=</span>U_sim <span class="op">+</span> Q_sim, size<span class="op">=</span>N)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>W_sim <span class="op">=</span> np.random.normal(loc<span class="op">=</span>U_sim <span class="op">+</span> <span class="dv">0</span> <span class="op">*</span> E_sim, size<span class="op">=</span>N)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>dat_sim <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"W"</span>: standardize(W_sim), <span class="st">"E"</span>: standardize(E_sim), <span class="st">"Q"</span>: standardize(Q_sim)}</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>dat_sim.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">W</th>
<th data-quarto-table-cell-role="th">E</th>
<th data-quarto-table-cell-role="th">Q</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.716876</td>
<td>-1.874122</td>
<td>-1.296704</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-1.528818</td>
<td>-2.237535</td>
<td>-1.296704</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.057729</td>
<td>0.225430</td>
<td>-1.296704</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.586142</td>
<td>0.822406</td>
<td>0.450875</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.454206</td>
<td>-0.527773</td>
<td>-1.296704</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.24" class="level4">
<h4 class="anchored" data-anchor-id="code-14.24">Code 14.24</h4>
<p>just regressing wage with education. The effect of education is positive due to the confounder U.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:04.531846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:04.531640Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:39.597804Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:39.596852Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:04.531811Z&quot;}" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_4:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    aW <span class="op">=</span> pm.Normal(<span class="st">"aW"</span>, <span class="fl">0.0</span>, <span class="fl">0.2</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    bEW <span class="op">=</span> pm.Normal(<span class="st">"bEW"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> aW <span class="op">+</span> bEW <span class="op">*</span> dat_sim.E.values</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.Exponential(<span class="st">"sigma"</span>, <span class="fl">1.0</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    W_obs <span class="op">=</span> pm.Data(<span class="st">"W_obs"</span>, dat_sim.W.values, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> pm.Normal(<span class="st">"W"</span>, mu, sigma, observed<span class="op">=</span>W_obs)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    trace_14_4 <span class="op">=</span> pm.sample(random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_4, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [aW, bEW, sigma]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 3 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:01&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">aW</td>
<td>0.00</td>
<td>0.04</td>
<td>-0.06</td>
<td>0.06</td>
<td>0.0</td>
<td>0.0</td>
<td>5405.40</td>
<td>3009.13</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bEW</td>
<td>0.45</td>
<td>0.04</td>
<td>0.38</td>
<td>0.51</td>
<td>0.0</td>
<td>0.0</td>
<td>6053.69</td>
<td>2790.47</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma</td>
<td>0.90</td>
<td>0.03</td>
<td>0.85</td>
<td>0.94</td>
<td>0.0</td>
<td>0.0</td>
<td>6413.39</td>
<td>3343.67</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.25" class="level4">
<h4 class="anchored" data-anchor-id="code-14.25">Code 14.25</h4>
<p>Here we add Q to the model. This will amplify the bias because there is a noncausal path Q-&gt;E&lt;-U-&gt;W with E observed (closed path). This means that adding Q will amplify the confounding effect of U.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:39.601454Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:39.601220Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:04:51.783455Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:04:51.782465Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:39.601432Z&quot;}" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_5:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    aW <span class="op">=</span> pm.Normal(<span class="st">"aW"</span>, <span class="fl">0.0</span>, <span class="fl">0.2</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    bEW <span class="op">=</span> pm.Normal(<span class="st">"bEW"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    bQW <span class="op">=</span> pm.Normal(<span class="st">"bQW"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> aW <span class="op">+</span> bEW <span class="op">*</span> dat_sim.E.values <span class="op">+</span> bQW <span class="op">*</span> dat_sim.Q.values</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.Exponential(<span class="st">"sigma"</span>, <span class="fl">1.0</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> pm.Normal(<span class="st">"W"</span>, mu, sigma, observed<span class="op">=</span>dat_sim.W.values)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    trace_14_5 <span class="op">=</span> pm.sample(random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_5, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [aW, bEW, bQW, sigma]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 3 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:02&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">aW</td>
<td>0.00</td>
<td>0.04</td>
<td>-0.06</td>
<td>0.06</td>
<td>0.0</td>
<td>0.0</td>
<td>3958.60</td>
<td>3260.89</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bEW</td>
<td>0.68</td>
<td>0.05</td>
<td>0.61</td>
<td>0.76</td>
<td>0.0</td>
<td>0.0</td>
<td>2500.69</td>
<td>3013.02</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bQW</td>
<td>-0.39</td>
<td>0.05</td>
<td>-0.47</td>
<td>-0.32</td>
<td>0.0</td>
<td>0.0</td>
<td>2827.70</td>
<td>2857.70</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma</td>
<td>0.84</td>
<td>0.03</td>
<td>0.80</td>
<td>0.88</td>
<td>0.0</td>
<td>0.0</td>
<td>4392.55</td>
<td>3352.92</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.26" class="level4">
<h4 class="anchored" data-anchor-id="code-14.26">Code 14.26</h4>
<p>Here we use Q properly as instrumental variable influencing E, and separately we model the relationship of E influencing W. The two linear models are put in relationship with a multivariate normal, so that</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:04:51.785096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:04:51.784866Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:04.082256Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:04.080203Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:04:51.785071Z&quot;}" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_6:</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    aW <span class="op">=</span> pm.Normal(<span class="st">"aW"</span>, <span class="fl">0.0</span>, <span class="fl">0.2</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    aE <span class="op">=</span> pm.Normal(<span class="st">"aE"</span>, <span class="fl">0.0</span>, <span class="fl">0.2</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    bEW <span class="op">=</span> pm.Normal(<span class="st">"bEW"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    bQE <span class="op">=</span> pm.Normal(<span class="st">"bQE"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    muW <span class="op">=</span> aW <span class="op">+</span> bEW <span class="op">*</span> dat_sim.E.values</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    muE <span class="op">=</span> aE <span class="op">+</span> bQE <span class="op">*</span> dat_sim.Q.values</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    chol, _, _ <span class="op">=</span> pm.LKJCholeskyCov(</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"chol_cov"</span>, n<span class="op">=</span><span class="dv">2</span>, eta<span class="op">=</span><span class="dv">2</span>, sd_dist<span class="op">=</span>pm.Exponential.dist(<span class="fl">1.0</span>), compute_corr<span class="op">=</span><span class="va">True</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    WE_obs <span class="op">=</span> pm.Data(<span class="st">"WE_obs"</span>, dat_sim[[<span class="st">"W"</span>, <span class="st">"E"</span>]].values, mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    WE <span class="op">=</span> pm.MvNormal(<span class="st">"WE"</span>, mu<span class="op">=</span>at.stack([muW, muE]).T, chol<span class="op">=</span>chol, observed<span class="op">=</span>WE_obs)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_6.nc'</span>)):</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>        trace_14_6 <span class="op">=</span> pm.sample(<span class="dv">2000</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        trace_14_6.rename({<span class="st">"chol_cov_corr"</span>: <span class="st">"Rho"</span>, <span class="st">"chol_cov_stds"</span>: <span class="st">"Sigma"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_6, <span class="st">'trace_14_6.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:04.085607Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:04.084962Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:04.203132Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:04.202359Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:04.085553Z&quot;}" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>trace_14_6 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_6.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:04.204212Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:04.204011Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:04.356466Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:04.355741Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:04.204194Z&quot;}" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_6, var_names<span class="op">=</span>[<span class="st">"aW"</span>, <span class="st">"aE"</span>, <span class="st">"bEW"</span>, <span class="st">"bQE"</span>, <span class="st">"Rho"</span>, <span class="st">"Sigma"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/work/home/SamueleSoraggi#7953/Repositories/bayesian_statistics/statistical_rethinking_2/pymc4/pymc4_env_2/lib/python3.10/site-packages/arviz/stats/diagnostics.py:584: RuntimeWarning: invalid value encountered in scalar divide
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">aW</td>
<td>-0.00</td>
<td>0.04</td>
<td>-0.06</td>
<td>0.07</td>
<td>0.0</td>
<td>0.0</td>
<td>7220.47</td>
<td>5598.00</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">aE</td>
<td>0.00</td>
<td>0.03</td>
<td>-0.05</td>
<td>0.05</td>
<td>0.0</td>
<td>0.0</td>
<td>7030.25</td>
<td>5955.54</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bEW</td>
<td>0.05</td>
<td>0.07</td>
<td>-0.07</td>
<td>0.16</td>
<td>0.0</td>
<td>0.0</td>
<td>3439.58</td>
<td>4415.86</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bQE</td>
<td>0.61</td>
<td>0.04</td>
<td>0.55</td>
<td>0.67</td>
<td>0.0</td>
<td>0.0</td>
<td>5776.15</td>
<td>5758.36</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[0, 0]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>8000.00</td>
<td>8000.00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[0, 1]</td>
<td>0.51</td>
<td>0.05</td>
<td>0.43</td>
<td>0.60</td>
<td>0.0</td>
<td>0.0</td>
<td>3702.76</td>
<td>4173.17</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[1, 0]</td>
<td>0.51</td>
<td>0.05</td>
<td>0.43</td>
<td>0.60</td>
<td>0.0</td>
<td>0.0</td>
<td>3702.76</td>
<td>4173.17</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[1, 1]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>7497.82</td>
<td>7464.45</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Sigma[0]</td>
<td>0.98</td>
<td>0.04</td>
<td>0.91</td>
<td>1.05</td>
<td>0.0</td>
<td>0.0</td>
<td>4189.46</td>
<td>4720.56</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sigma[1]</td>
<td>0.79</td>
<td>0.02</td>
<td>0.75</td>
<td>0.83</td>
<td>0.0</td>
<td>0.0</td>
<td>9785.88</td>
<td>6562.59</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:04.357686Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:04.357453Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:07.285580Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:07.284517Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:04.357665Z&quot;}" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not displaying Rho variable as it causes error</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>az.plot_trace(trace_14_6, var_names<span class="op">=</span>[<span class="st">"aW"</span>, <span class="st">"aE"</span>, <span class="st">"bEW"</span>, <span class="st">"bQE"</span>, <span class="st">"Sigma"</span>], compact<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-42-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.27" class="level4">
<h4 class="anchored" data-anchor-id="code-14.27">Code 14.27</h4>
<p>Code to test other models you wish to simulate with different values for W and E</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:07.287587Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:07.287322Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:07.295827Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:07.294800Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:07.287561Z&quot;}" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#with m14_4:</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    pm.set_data({"W_obs": dat_sim.W.values})  # replace `dat_sim.W` with new obs</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    trace_14_4x = pm.sample(random_seed=RANDOM_SEED)</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#with m14_6:</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    pm.set_data(</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">#        {"WE_obs": dat_sim[["W", "E"]].values}</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    )  # replace `dat_sim[["W", "E"]].values` with new obs</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">#    if(not os.path.exists('trace_14_6x.nc')):</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">#        trace_14_6x = pm.sample(2000, random_seed=RANDOM_SEED)</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">#        az.InferenceData.to_netcdf(trace_14_6x, 'trace_14_6x.nc')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:07.299232Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:07.299000Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:07.392721Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:07.391290Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:07.299213Z&quot;}" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trace_14_6x = az.from_netcdf('trace_14_6x.nc')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.28" class="level4">
<h4 class="anchored" data-anchor-id="code-14.28">Code 14.28</h4>
<p>Now data is simulated differently, with U compensating negatively for the positive effect of E</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:07.395586Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:07.394879Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:05:07.474560Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:05:07.473842Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:07.395532Z&quot;}" data-tags="[]" data-execution_count="25">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>U_sim <span class="op">=</span> np.random.normal(size<span class="op">=</span>N)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>Q_sim <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">5</span>, N)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>E_sim <span class="op">=</span> np.random.normal(loc<span class="op">=</span>U_sim <span class="op">+</span> Q_sim, size<span class="op">=</span>N)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>W_sim <span class="op">=</span> np.random.normal(loc<span class="op">=-</span>U_sim <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> E_sim, size<span class="op">=</span>N)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>dat_sim2 <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"W"</span>: standardize(W_sim), <span class="st">"E"</span>: standardize(E_sim), <span class="st">"Q"</span>: standardize(Q_sim)}</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>dat_sim2.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">W</th>
<th data-quarto-table-cell-role="th">E</th>
<th data-quarto-table-cell-role="th">Q</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.615649</td>
<td>-0.442994</td>
<td>-1.277258</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.068766</td>
<td>0.271918</td>
<td>1.332942</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.968147</td>
<td>0.642637</td>
<td>0.462875</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.872208</td>
<td>2.037869</td>
<td>1.332942</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.750804</td>
<td>-0.216989</td>
<td>1.332942</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:05:07.475703Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:05:07.475487Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:22:28.984636Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:22:28.983175Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:05:07.475683Z&quot;}" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m14_4:</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    pm.set_data({<span class="st">"W_obs"</span>: dat_sim2.W.values})</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    trace_14_4x <span class="op">=</span> pm.sample(random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m14_6:</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    pm.set_data({<span class="st">"WE_obs"</span>: dat_sim2[[<span class="st">"W"</span>, <span class="st">"E"</span>]].values})</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_6xx.nc'</span>)):</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        trace_14_6xx <span class="op">=</span> pm.sample(<span class="dv">2000</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        trace_14_6xx.posterior <span class="op">=</span> trace_14_6xx.posterior.rename_vars(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"chol_cov_corr"</span>: <span class="st">"Rho"</span>, <span class="st">"chol_cov_stds"</span>: <span class="st">"Sigma"</span>})</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_6xx, <span class="st">'trace_14_6xx.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [aW, bEW, sigma]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 2 seconds.
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [aW, aE, bEW, bQE, chol_cov]
Sampling 4 chains for 1_000 tune and 2_000 draw iterations (4_000 + 8_000 draws total) took 896 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:01&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="12000" class="" max="12000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [12000/12000 14:54&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:22:28.986550Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:22:28.986310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:22:29.092309Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:22:29.091533Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:22:28.986524Z&quot;}" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>trace_14_6xx <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_6xx.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>here we observe negative correlation between the residuals of E and W, since there is positive influence of U on E and negative on W.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:22:46.933083Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:22:46.932216Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:22:47.105597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:22:47.104843Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:22:46.933022Z&quot;}" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_6xx, var_names<span class="op">=</span>[<span class="st">"aW"</span>, <span class="st">"aE"</span>, <span class="st">"bEW"</span>, <span class="st">"bQE"</span>, <span class="st">"Rho"</span>, <span class="st">"Sigma"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/work/home/SamueleSoraggi#7953/Repositories/bayesian_statistics/statistical_rethinking_2/pymc4/pymc4_env_2/lib/python3.10/site-packages/arviz/stats/diagnostics.py:584: RuntimeWarning: invalid value encountered in scalar divide
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">aW</td>
<td>0.00</td>
<td>0.04</td>
<td>-0.07</td>
<td>0.07</td>
<td>0.0</td>
<td>0.0</td>
<td>9821.54</td>
<td>6644.52</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">aE</td>
<td>0.00</td>
<td>0.04</td>
<td>-0.07</td>
<td>0.07</td>
<td>0.0</td>
<td>0.0</td>
<td>9645.32</td>
<td>6077.36</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bEW</td>
<td>-0.03</td>
<td>0.04</td>
<td>-0.10</td>
<td>0.04</td>
<td>0.0</td>
<td>0.0</td>
<td>12281.35</td>
<td>6582.55</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bQE</td>
<td>0.06</td>
<td>0.04</td>
<td>-0.01</td>
<td>0.13</td>
<td>0.0</td>
<td>0.0</td>
<td>11635.10</td>
<td>6473.03</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[0, 0]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>8000.00</td>
<td>8000.00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[0, 1]</td>
<td>-0.16</td>
<td>0.04</td>
<td>-0.23</td>
<td>-0.10</td>
<td>0.0</td>
<td>0.0</td>
<td>10323.71</td>
<td>6609.64</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho[1, 0]</td>
<td>-0.16</td>
<td>0.04</td>
<td>-0.23</td>
<td>-0.10</td>
<td>0.0</td>
<td>0.0</td>
<td>10323.71</td>
<td>6609.64</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho[1, 1]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>7481.20</td>
<td>7977.24</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Sigma[0]</td>
<td>1.00</td>
<td>0.03</td>
<td>0.95</td>
<td>1.05</td>
<td>0.0</td>
<td>0.0</td>
<td>11691.07</td>
<td>6643.85</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sigma[1]</td>
<td>1.00</td>
<td>0.03</td>
<td>0.95</td>
<td>1.05</td>
<td>0.0</td>
<td>0.0</td>
<td>12832.64</td>
<td>6142.06</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.29" class="level4">
<h4 class="anchored" data-anchor-id="code-14.29">Code 14.29</h4>
<p>Using <a href="https://github.com/ijmbarr/causalgraphicalmodels"><code>causalgraphicalmodels</code></a> for graph drawing and analysis instead of <code>dagitty</code>, following the example of <a href="https://github.com/fehiepsi/rethinking-numpyro">fehiepsi’s NumPyro version of Rethinking</a>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:35:29.879249Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:35:29.878407Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:35:29.886567Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:35:29.884860Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:35:29.879189Z&quot;}" data-tags="[]" data-execution_count="32">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#from causalgraphicalmodels import CausalGraphicalModel</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#dagIV = CausalGraphicalModel(</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    nodes=["E", "W", "U", "Q"], edges=[("E", "W"), ("U", "E"), ("U", "W"), ("Q", "E")]</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">#for s in dagIV.observed_variables:</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co">#    if s in ["E", "W"]:</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co">#        continue</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co">#    cond1 = not dagIV.is_d_separated(s, "E")</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co">#    cond2 = dagIV.do("E").is_d_separated(s, "W")</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="co">#    if cond1 and cond2:</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(s)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p>pairs of families give and receive gifts. Those gifts are counted for each diads.</p>
<section id="code-14.30" class="level4">
<h4 class="anchored" data-anchor-id="code-14.30">Code 14.30</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:36:42.864990Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:36:42.864286Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:36:42.933698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:36:42.933004Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:36:42.864892Z&quot;}" data-tags="[]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>kl_dyads <span class="op">=</span> pd.read_csv(<span class="st">"Data/KosterLeckie.csv"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>kl_dyads</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hidA</th>
<th data-quarto-table-cell-role="th">hidB</th>
<th data-quarto-table-cell-role="th">did</th>
<th data-quarto-table-cell-role="th">giftsAB</th>
<th data-quarto-table-cell-role="th">giftsBA</th>
<th data-quarto-table-cell-role="th">offset</th>
<th data-quarto-table-cell-role="th">drel1</th>
<th data-quarto-table-cell-role="th">drel2</th>
<th data-quarto-table-cell-role="th">drel3</th>
<th data-quarto-table-cell-role="th">drel4</th>
<th data-quarto-table-cell-role="th">dlndist</th>
<th data-quarto-table-cell-role="th">dass</th>
<th data-quarto-table-cell-role="th">d0125</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>0</td>
<td>4</td>
<td>0.000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>-2.790</td>
<td>0.000</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>6</td>
<td>31</td>
<td>-0.003</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>-2.817</td>
<td>0.044</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>4</td>
<td>3</td>
<td>2</td>
<td>5</td>
<td>-0.019</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>-1.886</td>
<td>0.025</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>5</td>
<td>4</td>
<td>4</td>
<td>2</td>
<td>0.000</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>-1.892</td>
<td>0.011</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>6</td>
<td>5</td>
<td>8</td>
<td>2</td>
<td>-0.003</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>-3.499</td>
<td>0.022</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">295</td>
<td>22</td>
<td>24</td>
<td>296</td>
<td>0</td>
<td>1</td>
<td>0.000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>-2.442</td>
<td>0.000</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">296</td>
<td>22</td>
<td>25</td>
<td>297</td>
<td>2</td>
<td>0</td>
<td>-0.637</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>-1.747</td>
<td>0.026</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">297</td>
<td>23</td>
<td>24</td>
<td>298</td>
<td>2</td>
<td>0</td>
<td>-0.092</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>-1.798</td>
<td>0.000</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">298</td>
<td>23</td>
<td>25</td>
<td>299</td>
<td>4</td>
<td>0</td>
<td>-0.818</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>-1.848</td>
<td>0.031</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">299</td>
<td>24</td>
<td>25</td>
<td>300</td>
<td>2</td>
<td>0</td>
<td>-0.637</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>-1.723</td>
<td>0.042</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>300 rows × 13 columns</p>
</div>
</div>
</div>
</section>
<section id="code-14.31" class="level4">
<h4 class="anchored" data-anchor-id="code-14.31">Code 14.31</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:36:49.606009Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:36:49.605327Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T08:36:49.615444Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T08:36:49.614415Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:36:49.605937Z&quot;}" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="bu">len</span>(kl_dyads)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>N_households <span class="op">=</span> kl_dyads.hidB.<span class="bu">max</span>()</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>did <span class="op">=</span> (kl_dyads.did <span class="op">-</span> <span class="dv">1</span>).values</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>hidA <span class="op">=</span> (kl_dyads.hidA <span class="op">-</span> <span class="dv">1</span>).values</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>hidB <span class="op">=</span> (kl_dyads.hidB <span class="op">-</span> <span class="dv">1</span>).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To specify the matrix <code>d</code> of dyad effects, you can’t force the standard deviations to be the same in PyMC (at least not yet ;)). The model will infer it though, as they are basically the same. To convince you, just run:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>az.summary(idata_14_7, var_names<span class="op">=</span>[<span class="st">"Rho_d"</span>, <span class="st">"sigma_d"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T08:38:53.073728Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T08:38:53.073073Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T10:41:54.458556Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T10:41:54.457330Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T08:38:53.073674Z&quot;}" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_7:</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## gr matrix of varying effects</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    sd_dist <span class="op">=</span> pm.Exponential.dist(<span class="fl">1.0</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    chol_gr, _, _ <span class="op">=</span> pm.LKJCholeskyCov(<span class="st">"chol_gr"</span>, n<span class="op">=</span><span class="dv">2</span>, eta<span class="op">=</span><span class="dv">4</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    gr <span class="op">=</span> pm.MvNormal(<span class="st">"gr"</span>, mu<span class="op">=</span><span class="fl">0.0</span>, chol<span class="op">=</span>chol_gr, shape<span class="op">=</span>(N_households, <span class="dv">2</span>))</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## dyad effects</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    chol_dyad, _, _ <span class="op">=</span> pm.LKJCholeskyCov(<span class="st">"chol_dyad"</span>, n<span class="op">=</span><span class="dv">2</span>, eta<span class="op">=</span><span class="dv">8</span>, sd_dist<span class="op">=</span>sd_dist, compute_corr<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> pm.Normal(<span class="st">"z"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, shape<span class="op">=</span>(<span class="dv">2</span>, N))</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> pm.Deterministic(<span class="st">"d"</span>, pm.math.dot(chol_dyad, z).T)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># linear models</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Normal(<span class="st">"a"</span>, mu<span class="op">=</span><span class="fl">0.0</span>, sigma<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    lambdaAB <span class="op">=</span> pm.math.exp(a <span class="op">+</span> gr[hidA, <span class="dv">0</span>] <span class="op">+</span> gr[hidB, <span class="dv">1</span>] <span class="op">+</span> d[did, <span class="dv">0</span>])</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    lambdaBA <span class="op">=</span> pm.math.exp(a <span class="op">+</span> gr[hidB, <span class="dv">0</span>] <span class="op">+</span> gr[hidA, <span class="dv">1</span>] <span class="op">+</span> d[did, <span class="dv">1</span>])</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    giftsAB <span class="op">=</span> pm.Poisson(<span class="st">"giftsAB"</span>, lambdaAB, observed<span class="op">=</span>kl_dyads.giftsAB)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    giftsBA <span class="op">=</span> pm.Poisson(<span class="st">"giftsBA"</span>, lambdaBA, observed<span class="op">=</span>kl_dyads.giftsBA)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_7.nc'</span>)):</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        trace_14_7 <span class="op">=</span> pm.sample(<span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">3000</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        post <span class="op">=</span> trace_14_7.posterior <span class="op">=</span> trace_14_7.posterior.rename_vars(</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"chol_gr_corr"</span>: <span class="st">"Rho_gr"</span>,</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"chol_gr_stds"</span>: <span class="st">"sigma_gr"</span>,</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"chol_dyad_corr"</span>: <span class="st">"Rho_d"</span>,</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"chol_dyad_stds"</span>: <span class="st">"sigma_d"</span>,</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>            } </span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_7, <span class="st">'trace_14_7.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [chol_gr, gr, chol_dyad, z, a]
Sampling 4 chains for 3_000 tune and 2_000 draw iterations (12_000 + 8_000 draws total) took 7316 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="20000" class="" max="20000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [20000/20000 2:01:54&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:07.609834Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:07.608796Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:07.753490Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:07.752377Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:07.609750Z&quot;}" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>trace_14_7 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_7.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.32" class="level4">
<h4 class="anchored" data-anchor-id="code-14.32">Code 14.32</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:09.043416Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:09.042620Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:09.163599Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:09.162860Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:09.043348Z&quot;}" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_7, var_names<span class="op">=</span>[<span class="st">"Rho_gr"</span>, <span class="st">"sigma_gr"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/work/home/SamueleSoraggi#7953/Repositories/bayesian_statistics/statistical_rethinking_2/pymc4/pymc4_env_2/lib/python3.10/site-packages/arviz/stats/diagnostics.py:584: RuntimeWarning: invalid value encountered in scalar divide
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho_gr[0, 0]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>8000.00</td>
<td>8000.00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho_gr[0, 1]</td>
<td>-0.41</td>
<td>0.20</td>
<td>-0.74</td>
<td>-0.12</td>
<td>0.0</td>
<td>0.0</td>
<td>2415.31</td>
<td>3117.11</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho_gr[1, 0]</td>
<td>-0.41</td>
<td>0.20</td>
<td>-0.74</td>
<td>-0.12</td>
<td>0.0</td>
<td>0.0</td>
<td>2415.31</td>
<td>3117.11</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho_gr[1, 1]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>7625.79</td>
<td>7965.48</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_gr[0]</td>
<td>0.83</td>
<td>0.14</td>
<td>0.60</td>
<td>1.03</td>
<td>0.0</td>
<td>0.0</td>
<td>3378.50</td>
<td>4734.34</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_gr[1]</td>
<td>0.42</td>
<td>0.09</td>
<td>0.27</td>
<td>0.55</td>
<td>0.0</td>
<td>0.0</td>
<td>1835.72</td>
<td>3538.41</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.33" class="level4">
<h4 class="anchored" data-anchor-id="code-14.33">Code 14.33</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:19.278919Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:19.278145Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:19.305201Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:19.304442Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:19.278864Z&quot;}" data-tags="[]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> (post[<span class="st">"a"</span>] <span class="op">+</span> post[<span class="st">"gr"</span>].sel({<span class="st">"gr_dim_1"</span>: <span class="dv">0</span>})).stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> (post[<span class="st">"a"</span>] <span class="op">+</span> post[<span class="st">"gr"</span>].sel({<span class="st">"gr_dim_1"</span>: <span class="dv">1</span>})).stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>Eg_mu <span class="op">=</span> np.exp(g).mean(dim<span class="op">=</span><span class="st">"sample"</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>Er_mu <span class="op">=</span> np.exp(r).mean(dim<span class="op">=</span><span class="st">"sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.34" class="level4">
<h4 class="anchored" data-anchor-id="code-14.34">Code 14.34</h4>
<p>Adapted from <a href="https://fehiepsi.github.io/rethinking-numpyro/14-adventures-in-covariance.html#Code-14.34">fehiepsi’s port</a> of <em>Rethinking</em> to NumPyro:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:30.055037Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:30.054238Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:30.734040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:30.733349Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:30.054965Z&quot;}" data-tags="[]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">101</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>ax.plot(x, x, <span class="st">"k--"</span>, lw<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ellipses</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> house <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">25</span>):</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> np.cov(np.stack([np.exp(g[house].values), np.exp(r[house].values)]))</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    Mu <span class="op">=</span> np.stack([np.exp(g[house].values.mean()), np.exp(r[house].values.mean())])</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    pearson <span class="op">=</span> Sigma[<span class="dv">0</span>, <span class="dv">1</span>] <span class="op">/</span> np.sqrt(Sigma[<span class="dv">0</span>, <span class="dv">0</span>] <span class="op">*</span> Sigma[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    ellipse <span class="op">=</span> Ellipse(</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>        np.sqrt(<span class="dv">1</span> <span class="op">+</span> pearson),</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>        np.sqrt(<span class="dv">1</span> <span class="op">-</span> pearson),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    std_dev <span class="op">=</span> stats.norm.ppf((<span class="dv">1</span> <span class="op">+</span> np.sqrt(<span class="fl">0.5</span>)) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    scale_x <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> std_dev <span class="op">*</span> np.sqrt(Sigma[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    scale_y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> std_dev <span class="op">*</span> np.sqrt(Sigma[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">=</span> transforms.Affine2D().rotate_deg(<span class="dv">45</span>).scale(scale_x, scale_y)</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    ellipse.set_transform(scale.translate(Mu[<span class="dv">0</span>], Mu[<span class="dv">1</span>]) <span class="op">+</span> ax.transData)</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(ellipse)</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="co"># household means</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>ax.plot(Eg_mu, Er_mu, <span class="st">"ko"</span>, mfc<span class="op">=</span><span class="st">"white"</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>    xlim<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">8.6</span>),</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>    ylim<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">8.6</span>),</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"generalized giving"</span>,</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"generalized receiving"</span>,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-56-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.35" class="level4">
<h4 class="anchored" data-anchor-id="code-14.35">Code 14.35</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:40.254314Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:40.253488Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:40.356338Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:40.355592Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:40.254252Z&quot;}" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_7, var_names<span class="op">=</span>[<span class="st">"Rho_d"</span>, <span class="st">"sigma_d"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/work/home/SamueleSoraggi#7953/Repositories/bayesian_statistics/statistical_rethinking_2/pymc4/pymc4_env_2/lib/python3.10/site-packages/arviz/stats/diagnostics.py:584: RuntimeWarning: invalid value encountered in scalar divide
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho_d[0, 0]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>8000.00</td>
<td>8000.00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho_d[0, 1]</td>
<td>0.88</td>
<td>0.03</td>
<td>0.83</td>
<td>0.94</td>
<td>0.0</td>
<td>0.0</td>
<td>1816.73</td>
<td>3548.11</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Rho_d[1, 0]</td>
<td>0.88</td>
<td>0.03</td>
<td>0.83</td>
<td>0.94</td>
<td>0.0</td>
<td>0.0</td>
<td>1816.73</td>
<td>3548.11</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Rho_d[1, 1]</td>
<td>1.00</td>
<td>0.00</td>
<td>1.00</td>
<td>1.00</td>
<td>0.0</td>
<td>0.0</td>
<td>7842.32</td>
<td>6613.17</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_d[0]</td>
<td>1.07</td>
<td>0.07</td>
<td>0.97</td>
<td>1.18</td>
<td>0.0</td>
<td>0.0</td>
<td>1727.51</td>
<td>3671.72</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_d[1]</td>
<td>1.13</td>
<td>0.07</td>
<td>1.02</td>
<td>1.23</td>
<td>0.0</td>
<td>0.0</td>
<td>2049.99</td>
<td>3338.75</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.36" class="level4">
<h4 class="anchored" data-anchor-id="code-14.36">Code 14.36</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:48.997953Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:48.997250Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:49.039702Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:49.038979Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:48.997897Z&quot;}" data-tags="[]" data-execution_count="42">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>dy1 <span class="op">=</span> post[<span class="st">"d"</span>].sel({<span class="st">"d_dim_1"</span>: <span class="dv">0</span>}).mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>dy2 <span class="op">=</span> post[<span class="st">"d"</span>].sel({<span class="st">"d_dim_1"</span>: <span class="dv">1</span>}).mean(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:48:49.552217Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:48:49.551488Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:48:49.919092Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:48:49.918354Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:48:49.552160Z&quot;}" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">101</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>ax.plot(x, x, <span class="st">"k--"</span>, lw<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>ax.axhline(linewidth<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"k"</span>, ls<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>ax.axvline(linewidth<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"k"</span>, ls<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>ax.plot(dy1, dy2, <span class="st">"ko"</span>, mfc<span class="op">=</span><span class="st">"none"</span>, lw<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    xlim<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    ylim<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"household A in dyad"</span>,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"household B in dyad"</span>,</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-59-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<p>spatial relationship example using the islands and their distance matrix</p>
<section id="code-14.37" class="level4">
<h4 class="anchored" data-anchor-id="code-14.37">Code 14.37</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:49:25.479896Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:49:25.479107Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:49:25.558054Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:49:25.557110Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:49:25.479839Z&quot;}" data-tags="[]" data-execution_count="44">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>Dmat <span class="op">=</span> pd.read_csv(<span class="st">"Data/islandsDistMatrix.csv"</span>, sep<span class="op">=</span><span class="st">","</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>Dmat.<span class="bu">round</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Ml</th>
<th data-quarto-table-cell-role="th">Ti</th>
<th data-quarto-table-cell-role="th">SC</th>
<th data-quarto-table-cell-role="th">Ya</th>
<th data-quarto-table-cell-role="th">Fi</th>
<th data-quarto-table-cell-role="th">Tr</th>
<th data-quarto-table-cell-role="th">Ch</th>
<th data-quarto-table-cell-role="th">Mn</th>
<th data-quarto-table-cell-role="th">To</th>
<th data-quarto-table-cell-role="th">Ha</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Malekula</td>
<td>0.0</td>
<td>0.5</td>
<td>0.6</td>
<td>4.4</td>
<td>1.2</td>
<td>2.0</td>
<td>3.2</td>
<td>2.8</td>
<td>1.9</td>
<td>5.7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Tikopia</td>
<td>0.5</td>
<td>0.0</td>
<td>0.3</td>
<td>4.2</td>
<td>1.2</td>
<td>2.0</td>
<td>2.9</td>
<td>2.7</td>
<td>2.0</td>
<td>5.3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Santa Cruz</td>
<td>0.6</td>
<td>0.3</td>
<td>0.0</td>
<td>3.9</td>
<td>1.6</td>
<td>1.7</td>
<td>2.6</td>
<td>2.4</td>
<td>2.3</td>
<td>5.4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Yap</td>
<td>4.4</td>
<td>4.2</td>
<td>3.9</td>
<td>0.0</td>
<td>5.4</td>
<td>2.5</td>
<td>1.6</td>
<td>1.6</td>
<td>6.1</td>
<td>7.2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Lau Fiji</td>
<td>1.2</td>
<td>1.2</td>
<td>1.6</td>
<td>5.4</td>
<td>0.0</td>
<td>3.2</td>
<td>4.0</td>
<td>3.9</td>
<td>0.8</td>
<td>4.9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Trobriand</td>
<td>2.0</td>
<td>2.0</td>
<td>1.7</td>
<td>2.5</td>
<td>3.2</td>
<td>0.0</td>
<td>1.8</td>
<td>0.8</td>
<td>3.9</td>
<td>6.7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Chuuk</td>
<td>3.2</td>
<td>2.9</td>
<td>2.6</td>
<td>1.6</td>
<td>4.0</td>
<td>1.8</td>
<td>0.0</td>
<td>1.2</td>
<td>4.8</td>
<td>5.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manus</td>
<td>2.8</td>
<td>2.7</td>
<td>2.4</td>
<td>1.6</td>
<td>3.9</td>
<td>0.8</td>
<td>1.2</td>
<td>0.0</td>
<td>4.6</td>
<td>6.7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Tonga</td>
<td>1.9</td>
<td>2.0</td>
<td>2.3</td>
<td>6.1</td>
<td>0.8</td>
<td>3.9</td>
<td>4.8</td>
<td>4.6</td>
<td>0.0</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Hawaii</td>
<td>5.7</td>
<td>5.3</td>
<td>5.4</td>
<td>7.2</td>
<td>4.9</td>
<td>6.7</td>
<td>5.8</td>
<td>6.7</td>
<td>5.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.38" class="level4">
<h4 class="anchored" data-anchor-id="code-14.38">Code 14.38</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:49:26.883373Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:49:26.882562Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:49:27.188714Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:49:27.187864Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:49:26.883315Z&quot;}" data-tags="[]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="bu">xrange</span> <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">100</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># linear</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>ax.plot(<span class="bu">xrange</span>, np.exp(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span> <span class="bu">xrange</span>), <span class="st">"k--"</span>, label<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"># squared</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>ax.plot(<span class="bu">xrange</span>, np.exp(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span> <span class="bu">xrange</span><span class="op">**</span><span class="dv">2</span>), <span class="st">"k"</span>, label<span class="op">=</span><span class="st">"squared"</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"distance"</span>)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"correlation"</span>)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-61-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.39" class="level4">
<h4 class="anchored" data-anchor-id="code-14.39">Code 14.39</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:49:29.504924Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:49:29.504131Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T12:49:29.589063Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T12:49:29.588086Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:49:29.504867Z&quot;}" data-tags="[]" data-execution_count="46">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the ordinary data, now with coordinates</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>dk <span class="op">=</span> pd.read_csv(<span class="st">"Data/Kline2.csv"</span>, sep<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>Nsociety <span class="op">=</span> dk.shape[<span class="dv">0</span>]</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>society <span class="op">=</span> np.arange(Nsociety)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>total_tools <span class="op">=</span> dk.total_tools.values</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>Dmat <span class="op">=</span> Dmat.values</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>Dmatsq <span class="op">=</span> np.power(Dmat, <span class="dv">2</span>)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> standardize(np.log(dk.population)).values</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> P <span class="op">+</span> np.<span class="bu">abs</span>(P.<span class="bu">min</span>()) <span class="op">+</span> <span class="fl">0.1</span>  <span class="co"># must be &gt; 0, see chp 11</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>dk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culture</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">contact</th>
<th data-quarto-table-cell-role="th">total_tools</th>
<th data-quarto-table-cell-role="th">mean_TU</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lon2</th>
<th data-quarto-table-cell-role="th">logpop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Malekula</td>
<td>1100</td>
<td>low</td>
<td>13</td>
<td>3.2</td>
<td>-16.3</td>
<td>167.5</td>
<td>-12.5</td>
<td>7.003065</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Tikopia</td>
<td>1500</td>
<td>low</td>
<td>22</td>
<td>4.7</td>
<td>-12.3</td>
<td>168.8</td>
<td>-11.2</td>
<td>7.313220</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Santa Cruz</td>
<td>3600</td>
<td>low</td>
<td>24</td>
<td>4.0</td>
<td>-10.7</td>
<td>166.0</td>
<td>-14.0</td>
<td>8.188689</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Yap</td>
<td>4791</td>
<td>high</td>
<td>43</td>
<td>5.0</td>
<td>9.5</td>
<td>138.1</td>
<td>-41.9</td>
<td>8.474494</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Lau Fiji</td>
<td>7400</td>
<td>high</td>
<td>33</td>
<td>5.0</td>
<td>-17.7</td>
<td>178.1</td>
<td>-1.9</td>
<td>8.909235</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Trobriand</td>
<td>8000</td>
<td>high</td>
<td>19</td>
<td>4.0</td>
<td>-8.7</td>
<td>150.9</td>
<td>-29.1</td>
<td>8.987197</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Chuuk</td>
<td>9200</td>
<td>high</td>
<td>40</td>
<td>3.8</td>
<td>7.4</td>
<td>151.6</td>
<td>-28.4</td>
<td>9.126959</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Manus</td>
<td>13000</td>
<td>low</td>
<td>28</td>
<td>6.6</td>
<td>-2.1</td>
<td>146.9</td>
<td>-33.1</td>
<td>9.472705</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Tonga</td>
<td>17500</td>
<td>high</td>
<td>55</td>
<td>5.4</td>
<td>-21.2</td>
<td>-175.2</td>
<td>4.8</td>
<td>9.769956</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Hawaii</td>
<td>275000</td>
<td>low</td>
<td>71</td>
<td>6.6</td>
<td>19.9</td>
<td>-155.6</td>
<td>24.4</td>
<td>12.524526</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T12:51:43.082664Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T12:51:43.081747Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T13:57:35.216396Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T13:57:35.214837Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T12:51:43.082591Z&quot;}" data-tags="[]" data-execution_count="48">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_8:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Exponential(<span class="st">"a"</span>, <span class="fl">1.0</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> pm.Exponential(<span class="st">"b"</span>, <span class="fl">1.0</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> pm.Exponential(<span class="st">"g"</span>, <span class="fl">1.0</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    etasq <span class="op">=</span> pm.Exponential(<span class="st">"etasq"</span>, <span class="fl">2.0</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    ls_inv <span class="op">=</span> pm.HalfNormal(<span class="st">"ls_inv"</span>, <span class="fl">2.0</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    rhosq <span class="op">=</span> pm.Deterministic(<span class="st">"rhosq"</span>, <span class="fl">0.5</span> <span class="op">*</span> ls_inv<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implementation with PyMC's GP module:</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    cov <span class="op">=</span> etasq <span class="op">*</span> pm.gp.cov.ExpQuad(input_dim<span class="op">=</span><span class="dv">1</span>, ls_inv<span class="op">=</span>ls_inv)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    gp <span class="op">=</span> pm.gp.Latent(cov_func<span class="op">=</span>cov)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> gp.prior(<span class="st">"k"</span>, X<span class="op">=</span>Dmat)</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    lam <span class="op">=</span> (a <span class="op">*</span> P<span class="op">**</span>b <span class="op">/</span> g) <span class="op">*</span> at.exp(k[society])</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> pm.Poisson(<span class="st">"total_tools"</span>, lam, observed<span class="op">=</span>total_tools)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_8.nc'</span>)):</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>        trace_14_8 <span class="op">=</span> pm.sample(<span class="dv">4000</span>, tune<span class="op">=</span><span class="dv">2000</span>, target_accept<span class="op">=</span><span class="fl">0.99</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_8, <span class="st">'trace_14_8.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [a, b, g, etasq, ls_inv, k_rotated_]
Sampling 4 chains for 2_000 tune and 4_000 draw iterations (8_000 + 16_000 draws total) took 3930 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="24000" class="" max="24000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [24000/24000 1:05:29&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:06:37.296559Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:06:37.295946Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:06:37.407288Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:06:37.406504Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:06:37.296506Z&quot;}" data-tags="[]" data-execution_count="49">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>trace_14_8 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_8.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:06:37.950887Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:06:37.950232Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:06:43.376421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:06:43.375545Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:06:37.950837Z&quot;}" data-tags="[]" data-execution_count="50">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(trace_14_8, var_names<span class="op">=</span>[<span class="st">"~k_rotated_"</span>], compact<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.40" class="level4">
<h4 class="anchored" data-anchor-id="code-14.40">Code 14.40</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:06:43.378523Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:06:43.378133Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:06:43.708754Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:06:43.708037Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:06:43.378494Z&quot;}" data-tags="[]" data-execution_count="51">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_8, var_names<span class="op">=</span>[<span class="st">"~k_rotated_"</span>], round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">a</td>
<td>1.92</td>
<td>1.35</td>
<td>0.12</td>
<td>3.68</td>
<td>0.01</td>
<td>0.01</td>
<td>7715.35</td>
<td>6034.23</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">b</td>
<td>0.41</td>
<td>0.14</td>
<td>0.18</td>
<td>0.64</td>
<td>0.00</td>
<td>0.00</td>
<td>4066.52</td>
<td>2588.75</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">g</td>
<td>0.07</td>
<td>0.08</td>
<td>0.00</td>
<td>0.13</td>
<td>0.00</td>
<td>0.00</td>
<td>6927.63</td>
<td>6496.90</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">etasq</td>
<td>0.28</td>
<td>0.32</td>
<td>0.00</td>
<td>0.60</td>
<td>0.00</td>
<td>0.00</td>
<td>5180.27</td>
<td>7487.75</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ls_inv</td>
<td>1.92</td>
<td>1.61</td>
<td>0.00</td>
<td>4.15</td>
<td>0.05</td>
<td>0.03</td>
<td>1122.22</td>
<td>3804.46</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">rhosq</td>
<td>3.14</td>
<td>4.33</td>
<td>0.00</td>
<td>8.60</td>
<td>0.10</td>
<td>0.07</td>
<td>1122.22</td>
<td>3804.46</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">k[0]</td>
<td>0.06</td>
<td>0.46</td>
<td>-0.63</td>
<td>0.75</td>
<td>0.01</td>
<td>0.00</td>
<td>6194.02</td>
<td>8061.29</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">k[1]</td>
<td>0.02</td>
<td>0.41</td>
<td>-0.56</td>
<td>0.57</td>
<td>0.00</td>
<td>0.00</td>
<td>8143.69</td>
<td>6133.92</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">k[2]</td>
<td>-0.04</td>
<td>0.39</td>
<td>-0.58</td>
<td>0.47</td>
<td>0.00</td>
<td>0.00</td>
<td>9136.85</td>
<td>5234.16</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">k[3]</td>
<td>0.25</td>
<td>0.39</td>
<td>-0.27</td>
<td>0.79</td>
<td>0.00</td>
<td>0.00</td>
<td>9249.02</td>
<td>5634.66</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">k[4]</td>
<td>-0.01</td>
<td>0.39</td>
<td>-0.55</td>
<td>0.49</td>
<td>0.00</td>
<td>0.00</td>
<td>9792.66</td>
<td>5644.07</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">k[5]</td>
<td>-0.13</td>
<td>0.42</td>
<td>-0.74</td>
<td>0.42</td>
<td>0.01</td>
<td>0.00</td>
<td>4375.31</td>
<td>4906.19</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">k[6]</td>
<td>0.06</td>
<td>0.40</td>
<td>-0.49</td>
<td>0.59</td>
<td>0.00</td>
<td>0.00</td>
<td>8385.24</td>
<td>5729.29</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">k[7]</td>
<td>-0.12</td>
<td>0.43</td>
<td>-0.73</td>
<td>0.44</td>
<td>0.01</td>
<td>0.01</td>
<td>4111.68</td>
<td>4853.43</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">k[8]</td>
<td>0.06</td>
<td>0.41</td>
<td>-0.49</td>
<td>0.63</td>
<td>0.01</td>
<td>0.00</td>
<td>5177.93</td>
<td>6294.16</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">k[9]</td>
<td>0.28</td>
<td>0.42</td>
<td>-0.30</td>
<td>0.86</td>
<td>0.01</td>
<td>0.00</td>
<td>7357.03</td>
<td>5764.30</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.41" class="level4">
<h4 class="anchored" data-anchor-id="code-14.41">Code 14.41</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:06:52.051216Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:06:52.050515Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:06:52.068738Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:06:52.068183Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:06:52.051160Z&quot;}" data-tags="[]" data-execution_count="52">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute posterior median covariance</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>x_seq <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">100</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>post <span class="op">=</span> trace_14_8.posterior.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>pmcov_mu <span class="op">=</span> post[<span class="st">"etasq"</span>].median().values <span class="op">*</span> np.exp(<span class="op">-</span>post[<span class="st">"rhosq"</span>].median().values <span class="op">*</span> (x_seq<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:06:52.477241Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:06:52.476797Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:06:53.294134Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:06:53.293523Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:06:52.477203Z&quot;}" data-tags="[]" data-execution_count="53">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>))</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot functions sampled from posterior</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    x_seq,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        post[<span class="st">"etasq"</span>][::<span class="dv">50</span>].values[:, <span class="va">None</span>]</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> np.exp(<span class="op">-</span>post[<span class="st">"rhosq"</span>][::<span class="dv">50</span>].values[:, <span class="va">None</span>] <span class="op">*</span> (x_seq<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    ).T,</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k"</span>,</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.08</span>,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co"># plot median covariance function</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>ax.plot(x_seq, pmcov_mu, lw<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Gaussian process posterior"</span>,</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    ylim<span class="op">=</span>(<span class="op">-</span><span class="fl">0.1</span>, <span class="dv">2</span>),</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"distance (thousand km)"</span>,</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"covariance"</span>,</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-68-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.42" class="level4">
<h4 class="anchored" data-anchor-id="code-14.42">Code 14.42</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:07:00.859214Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:07:00.858827Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:07:00.863821Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:07:00.863301Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:07:00.859189Z&quot;}" data-tags="[]" data-execution_count="54">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute posterior median covariance among societies</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> post[<span class="st">"etasq"</span>].median().values <span class="op">*</span> np.exp(<span class="op">-</span>post[<span class="st">"rhosq"</span>].median().values <span class="op">*</span> Dmatsq) <span class="op">+</span> np.diag(</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.01</span>] <span class="op">*</span> Nsociety</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="code-14.43" class="level4">
<h4 class="anchored" data-anchor-id="code-14.43">Code 14.43</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:07:02.757133Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:07:02.756529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:07:02.776358Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:07:02.775833Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:07:02.757108Z&quot;}" data-tags="[]" data-execution_count="55">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to correlation matrix</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>sigma_post <span class="op">=</span> np.sqrt(np.diag(K))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>Rho <span class="op">=</span> (sigma_post<span class="op">**-</span><span class="dv">1</span>) <span class="op">*</span> K <span class="op">*</span> (sigma_post<span class="op">**-</span><span class="dv">1</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add row/col names for convenience</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>Rho <span class="op">=</span> pd.DataFrame(</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    Rho,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"Ml"</span>, <span class="st">"Ti"</span>, <span class="st">"SC"</span>, <span class="st">"Ya"</span>, <span class="st">"Fi"</span>, <span class="st">"Tr"</span>, <span class="st">"Ch"</span>, <span class="st">"Mn"</span>, <span class="st">"To"</span>, <span class="st">"Ha"</span>],</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"Ml"</span>, <span class="st">"Ti"</span>, <span class="st">"SC"</span>, <span class="st">"Ya"</span>, <span class="st">"Fi"</span>, <span class="st">"Tr"</span>, <span class="st">"Ch"</span>, <span class="st">"Mn"</span>, <span class="st">"To"</span>, <span class="st">"Ha"</span>],</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>Rho.<span class="bu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Ml</th>
<th data-quarto-table-cell-role="th">Ti</th>
<th data-quarto-table-cell-role="th">SC</th>
<th data-quarto-table-cell-role="th">Ya</th>
<th data-quarto-table-cell-role="th">Fi</th>
<th data-quarto-table-cell-role="th">Tr</th>
<th data-quarto-table-cell-role="th">Ch</th>
<th data-quarto-table-cell-role="th">Mn</th>
<th data-quarto-table-cell-role="th">To</th>
<th data-quarto-table-cell-role="th">Ha</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Ml</td>
<td>1.00</td>
<td>0.71</td>
<td>0.57</td>
<td>0.00</td>
<td>0.13</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.01</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Ti</td>
<td>0.71</td>
<td>1.00</td>
<td>0.83</td>
<td>0.00</td>
<td>0.13</td>
<td>0.01</td>
<td>0.00</td>
<td>0.00</td>
<td>0.01</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SC</td>
<td>0.57</td>
<td>0.83</td>
<td>1.00</td>
<td>0.00</td>
<td>0.04</td>
<td>0.02</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Ya</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>1.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.04</td>
<td>0.03</td>
<td>0.00</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Fi</td>
<td>0.13</td>
<td>0.13</td>
<td>0.04</td>
<td>0.00</td>
<td>1.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.45</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Tr</td>
<td>0.00</td>
<td>0.01</td>
<td>0.02</td>
<td>0.00</td>
<td>0.00</td>
<td>1.00</td>
<td>0.01</td>
<td>0.37</td>
<td>0.00</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Ch</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.04</td>
<td>0.00</td>
<td>0.01</td>
<td>1.00</td>
<td>0.14</td>
<td>0.00</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Mn</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.03</td>
<td>0.00</td>
<td>0.37</td>
<td>0.14</td>
<td>1.00</td>
<td>0.00</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">To</td>
<td>0.01</td>
<td>0.01</td>
<td>0.00</td>
<td>0.00</td>
<td>0.45</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>1.00</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Ha</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.44-and-14.45" class="level4">
<h4 class="anchored" data-anchor-id="code-14.44-and-14.45">Code 14.44 and 14.45</h4>
<p>There seems to be a typo in the book: the posterior predictive computations in the second plot are done according to the model from the first edition: <span class="math inline">\(\lambda = exp(\alpha + \beta_p x logpop)\)</span>. We’ll use the right version here, i.e the model that we just ran above: <span class="math inline">\(\lambda = \frac{\alpha P^\beta}{\gamma}\)</span>.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-11T14:07:33.270387Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-11T14:07:33.269956Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-11T14:07:34.112135Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-11T14:07:34.110472Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-11T14:07:33.270358Z&quot;}" data-tags="[]" data-execution_count="56">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Code 14.44</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scale point size to logpop</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>logpop <span class="op">=</span> np.copy(dk[<span class="st">"logpop"</span>].values)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>logpop <span class="op">/=</span> logpop.<span class="bu">max</span>()</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>psize <span class="op">=</span> np.exp(logpop <span class="op">*</span> <span class="fl">5.5</span>)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>_, (ax0, ax1) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plot raw data and labels</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>ax0.scatter(dk[<span class="st">"lon2"</span>], dk[<span class="st">"lat"</span>], psize, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> dk[<span class="st">"culture"</span>].values</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, itext <span class="kw">in</span> <span class="bu">enumerate</span>(labels):</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    ax0.text(dk[<span class="st">"lon2"</span>][i] <span class="op">+</span> <span class="dv">1</span>, dk[<span class="st">"lat"</span>][i] <span class="op">+</span> <span class="dv">1</span>, itext)</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co"># overlay lines shaded by Rho</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> np.arange(i <span class="op">+</span> <span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>        ax0.plot(</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>            [dk[<span class="st">"lon2"</span>][i], dk[<span class="st">"lon2"</span>][j]],</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>            [dk[<span class="st">"lat"</span>][i], dk[<span class="st">"lat"</span>][j]],</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"k-"</span>,</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span>Rho.iloc[i, j] <span class="op">**</span> <span class="dv">2</span>,</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>            lw<span class="op">=</span><span class="fl">2.5</span>,</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>ax0.set_xlabel(<span class="st">"longitude"</span>)</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>ax0.set_ylabel(<span class="st">"latitude"</span>)</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Code 14.45</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a><span class="co"># compute posterior median relationship, ignoring distance</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>P_seq <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">1.4</span>, <span class="fl">3.0</span>, <span class="dv">30</span>) <span class="op">+</span> <span class="fl">1.4</span>  <span class="co"># our little trick from chp 11</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>lambda_post <span class="op">=</span> (</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    post[<span class="st">"a"</span>].values[:, <span class="va">None</span>] <span class="op">*</span> P_seq <span class="op">**</span> post[<span class="st">"b"</span>].values[:, <span class="va">None</span>] <span class="op">/</span> post[<span class="st">"g"</span>].values[:, <span class="va">None</span>]</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="co"># plot raw data and labels</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>ax1.scatter(P, dk[<span class="st">"total_tools"</span>], psize, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> dk[<span class="st">"culture"</span>].values</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, itext <span class="kw">in</span> <span class="bu">enumerate</span>(labels):</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    ax1.text(P[i] <span class="op">+</span> <span class="fl">0.1</span>, dk[<span class="st">"total_tools"</span>][i] <span class="op">-</span> <span class="fl">2.5</span>, itext)</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a><span class="co"># display posterior predictions</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>ax1.plot(P_seq, np.median(lambda_post, axis<span class="op">=</span><span class="dv">0</span>), <span class="st">"--"</span>, color<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>    P_seq,</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>    lambda_post,</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax1,</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>    fill_kwargs<span class="op">=</span>{<span class="st">"alpha"</span>: <span class="dv">0</span>},</span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    plot_kwargs<span class="op">=</span>{<span class="st">"color"</span>: <span class="st">"k"</span>, <span class="st">"ls"</span>: <span class="st">"--"</span>, <span class="st">"alpha"</span>: <span class="fl">0.8</span>},</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a><span class="co"># overlay correlations</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> np.arange(i <span class="op">+</span> <span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>        ax1.plot(</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>            [P[i], P[j]],</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>            [dk[<span class="st">"total_tools"</span>][i], dk[<span class="st">"total_tools"</span>][j]],</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">"k-"</span>,</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span>Rho.iloc[i, j] <span class="op">**</span> <span class="dv">2</span>,</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>            lw<span class="op">=</span><span class="fl">2.5</span>,</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">"standardized population"</span>)</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"total tools"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-71-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.46" class="level4">
<h4 class="anchored" data-anchor-id="code-14.46">Code 14.46</h4>
<p>Related to Stan. PyMC’s GP module automatically reparametrizes with the Cholesky factor of the covariance matrix under the hood.</p>
</section>
</section>
<section id="example-2" class="level2">
<h2 class="anchored" data-anchor-id="example-2">Example</h2>
<p>Phylogenetic relationship between primates</p>
<section id="code-14.47" class="level4">
<h4 class="anchored" data-anchor-id="code-14.47">Code 14.47</h4>
<p>The <code>ape</code>-package-related computations are very specific to the example and not related to PyMC usage, so let’s just load the CSV file and the ready-made image:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T08:56:11.885476Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T08:56:11.884634Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T08:56:11.902046Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T08:56:11.901026Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T08:56:11.885417Z&quot;}" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>Primates301 <span class="op">=</span> pd.read_csv(<span class="st">"Data/Primates301.csv"</span>, sep<span class="op">=</span><span class="st">";"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Data/Primates301.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image</figcaption>
</figure>
</div>
</section>
<section id="code-14.48" class="level4">
<h4 class="anchored" data-anchor-id="code-14.48">Code 14.48</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T08:56:13.292093Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T08:56:13.291411Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T08:56:13.331471Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T08:56:13.330745Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T08:56:13.292037Z&quot;}" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>dpymc <span class="op">=</span> Primates301.dropna(subset<span class="op">=</span>[<span class="st">"group_size"</span>, <span class="st">"body"</span>, <span class="st">"brain"</span>])</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>spp_obs <span class="op">=</span> dpymc[<span class="st">"name"</span>]</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>dpymc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">genus</th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">subspecies</th>
<th data-quarto-table-cell-role="th">spp_id</th>
<th data-quarto-table-cell-role="th">genus_id</th>
<th data-quarto-table-cell-role="th">social_learning</th>
<th data-quarto-table-cell-role="th">research_effort</th>
<th data-quarto-table-cell-role="th">brain</th>
<th data-quarto-table-cell-role="th">body</th>
<th data-quarto-table-cell-role="th">group_size</th>
<th data-quarto-table-cell-role="th">gestation</th>
<th data-quarto-table-cell-role="th">weaning</th>
<th data-quarto-table-cell-role="th">longevity</th>
<th data-quarto-table-cell-role="th">sex_maturity</th>
<th data-quarto-table-cell-role="th">maternal_investment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Allenopithecus_nigroviridis</td>
<td>Allenopithecus</td>
<td>nigroviridis</td>
<td>NaN</td>
<td>1</td>
<td>1</td>
<td>0.0</td>
<td>6.0</td>
<td>58.02</td>
<td>4655.0</td>
<td>40.00</td>
<td>NaN</td>
<td>106.15</td>
<td>276.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>Alouatta_belzebul</td>
<td>Alouatta</td>
<td>belzebul</td>
<td>NaN</td>
<td>3</td>
<td>3</td>
<td>0.0</td>
<td>15.0</td>
<td>52.84</td>
<td>6395.0</td>
<td>7.40</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Alouatta_caraya</td>
<td>Alouatta</td>
<td>caraya</td>
<td>NaN</td>
<td>4</td>
<td>3</td>
<td>0.0</td>
<td>45.0</td>
<td>52.63</td>
<td>5383.0</td>
<td>8.90</td>
<td>185.92</td>
<td>323.16</td>
<td>243.6</td>
<td>1276.72</td>
<td>509.08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Alouatta_guariba</td>
<td>Alouatta</td>
<td>guariba</td>
<td>NaN</td>
<td>5</td>
<td>3</td>
<td>0.0</td>
<td>37.0</td>
<td>51.70</td>
<td>5175.0</td>
<td>7.40</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>Alouatta_palliata</td>
<td>Alouatta</td>
<td>palliata</td>
<td>NaN</td>
<td>6</td>
<td>3</td>
<td>3.0</td>
<td>79.0</td>
<td>49.88</td>
<td>6250.0</td>
<td>13.10</td>
<td>185.42</td>
<td>495.60</td>
<td>300.0</td>
<td>1578.42</td>
<td>681.02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">294</td>
<td>Trachypithecus_obscurus</td>
<td>Trachypithecus</td>
<td>obscurus</td>
<td>NaN</td>
<td>295</td>
<td>67</td>
<td>0.0</td>
<td>6.0</td>
<td>62.12</td>
<td>7056.0</td>
<td>10.00</td>
<td>146.63</td>
<td>362.93</td>
<td>300.0</td>
<td>NaN</td>
<td>509.56</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">295</td>
<td>Trachypithecus_phayrei</td>
<td>Trachypithecus</td>
<td>phayrei</td>
<td>NaN</td>
<td>296</td>
<td>67</td>
<td>0.0</td>
<td>16.0</td>
<td>72.84</td>
<td>7475.0</td>
<td>12.90</td>
<td>180.61</td>
<td>305.87</td>
<td>NaN</td>
<td>NaN</td>
<td>486.48</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">296</td>
<td>Trachypithecus_pileatus</td>
<td>Trachypithecus</td>
<td>pileatus</td>
<td>NaN</td>
<td>297</td>
<td>67</td>
<td>0.0</td>
<td>5.0</td>
<td>103.64</td>
<td>11794.0</td>
<td>8.50</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">298</td>
<td>Trachypithecus_vetulus</td>
<td>Trachypithecus</td>
<td>vetulus</td>
<td>NaN</td>
<td>299</td>
<td>67</td>
<td>0.0</td>
<td>2.0</td>
<td>61.29</td>
<td>6237.0</td>
<td>8.35</td>
<td>204.72</td>
<td>245.78</td>
<td>276.0</td>
<td>1113.70</td>
<td>450.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">300</td>
<td>Varecia_variegata_variegata</td>
<td>Varecia</td>
<td>variegata</td>
<td>variegata</td>
<td>301</td>
<td>68</td>
<td>0.0</td>
<td>57.0</td>
<td>32.12</td>
<td>3575.0</td>
<td>2.80</td>
<td>102.50</td>
<td>90.73</td>
<td>384.0</td>
<td>701.52</td>
<td>193.23</td>
</tr>
</tbody>
</table>

<p>151 rows × 16 columns</p>
</div>
</div>
</div>
</section>
<section id="code-14.49" class="level4">
<h4 class="anchored" data-anchor-id="code-14.49">Code 14.49</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T08:56:15.765301Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T08:56:15.764620Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T08:56:15.775392Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T08:56:15.773983Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T08:56:15.765244Z&quot;}" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>N_spp <span class="op">=</span> <span class="bu">len</span>(dpymc)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> standardize(np.log(dpymc.body.values))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>B_ <span class="op">=</span> standardize(np.log(dpymc.brain.values))</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> standardize(np.log(dpymc.group_size.values))</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>Imat <span class="op">=</span> np.diag(np.ones(N_spp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T08:57:25.495096Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T08:57:25.494435Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T09:15:38.103487Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T09:15:38.102306Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T08:57:25.495040Z&quot;}" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_9:</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Normal(<span class="st">"a"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    bM <span class="op">=</span> pm.Normal(<span class="st">"bM"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    bG <span class="op">=</span> pm.Normal(<span class="st">"bG"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="op">=</span> pm.Exponential(<span class="st">"sigma_sq"</span>, <span class="fl">1.0</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> a <span class="op">+</span> bM <span class="op">*</span> M <span class="op">+</span> bG <span class="op">*</span> G</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    SIGMA <span class="op">=</span> Imat <span class="op">*</span> sigma_sq</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> pm.MvNormal(<span class="st">"B"</span>, mu, cov<span class="op">=</span>SIGMA, observed<span class="op">=</span>B_)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_9.nc'</span>)):</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        trace_14_9 <span class="op">=</span> pm.sample(random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_9, <span class="st">'trace_14_9.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [a, bM, bG, sigma_sq]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 997 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 16:36&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T09:15:38.106025Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T09:15:38.105771Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T09:15:38.278715Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T09:15:38.278040Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T09:15:38.106000Z&quot;}" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>trace_14_9 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_9.nc'</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_9, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">a</td>
<td>0.00</td>
<td>0.02</td>
<td>-0.03</td>
<td>0.03</td>
<td>0.0</td>
<td>0.0</td>
<td>4283.18</td>
<td>2985.00</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bM</td>
<td>0.89</td>
<td>0.02</td>
<td>0.86</td>
<td>0.93</td>
<td>0.0</td>
<td>0.0</td>
<td>2526.05</td>
<td>2828.62</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bG</td>
<td>0.12</td>
<td>0.02</td>
<td>0.09</td>
<td>0.16</td>
<td>0.0</td>
<td>0.0</td>
<td>2705.94</td>
<td>2727.04</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_sq</td>
<td>0.05</td>
<td>0.01</td>
<td>0.04</td>
<td>0.06</td>
<td>0.0</td>
<td>0.0</td>
<td>3777.03</td>
<td>3015.92</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.50" class="level4">
<h4 class="anchored" data-anchor-id="code-14.50">Code 14.50</h4>
<p>The <code>ape</code>-package-related computations are very specific to the example and not related to PyMC usage, so let’s just load the CSV files:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T09:28:34.492554Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T09:28:34.491775Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T09:28:35.706700Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T09:28:35.705951Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T09:28:34.492497Z&quot;}" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>V <span class="op">=</span> pd.read_csv(<span class="st">"Data/Primates301_vcov_matrix.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>Dmat <span class="op">=</span> pd.read_csv(<span class="st">"Data/Primates301_distance_matrix.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>plt.plot(Dmat, V, <span class="st">"ko"</span>)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"phylogenetic distance"</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"covariance"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-77-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.51" class="level4">
<h4 class="anchored" data-anchor-id="code-14.51">Code 14.51</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T09:44:22.083556Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T09:44:22.082768Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T09:44:22.095155Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T09:44:22.094191Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T09:44:22.083501Z&quot;}" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put species in right order</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>V_ord <span class="op">=</span> V.loc[spp_obs, spp_obs]</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to correlation matrix</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> (V_ord <span class="op">/</span> V_ord.<span class="bu">max</span>()).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T09:45:15.341932Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T09:45:15.341135Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T10:01:14.573208Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T10:01:14.572167Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T09:45:15.341874Z&quot;}" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Brownian motion model</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_10:</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Normal(<span class="st">"a"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    bM <span class="op">=</span> pm.Normal(<span class="st">"bM"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    bG <span class="op">=</span> pm.Normal(<span class="st">"bG"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="op">=</span> pm.Exponential(<span class="st">"sigma_sq"</span>, <span class="fl">1.0</span>)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> a <span class="op">+</span> bM <span class="op">*</span> M <span class="op">+</span> bG <span class="op">*</span> G</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    SIGMA <span class="op">=</span> R <span class="op">*</span> sigma_sq</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> pm.MvNormal(<span class="st">"B"</span>, mu, cov<span class="op">=</span>SIGMA, observed<span class="op">=</span>B_)</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_10.nc'</span>)):</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>        trace_14_10 <span class="op">=</span> pm.sample(random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_10, <span class="st">'trace_14_10.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [a, bM, bG, sigma_sq]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 938 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 15:38&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T11:43:33.339086Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T11:43:33.338277Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T11:43:33.483248Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T11:43:33.482531Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T11:43:33.339030Z&quot;}" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>trace_14_10 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_10.nc'</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_10, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_5.5%</th>
<th data-quarto-table-cell-role="th">hdi_94.5%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">a</td>
<td>-0.19</td>
<td>0.17</td>
<td>-0.45</td>
<td>0.08</td>
<td>0.0</td>
<td>0.0</td>
<td>5696.55</td>
<td>3062.10</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bM</td>
<td>0.70</td>
<td>0.04</td>
<td>0.64</td>
<td>0.76</td>
<td>0.0</td>
<td>0.0</td>
<td>5906.64</td>
<td>3435.97</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bG</td>
<td>-0.01</td>
<td>0.02</td>
<td>-0.05</td>
<td>0.02</td>
<td>0.0</td>
<td>0.0</td>
<td>4672.62</td>
<td>2755.63</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_sq</td>
<td>0.16</td>
<td>0.02</td>
<td>0.13</td>
<td>0.19</td>
<td>0.0</td>
<td>0.0</td>
<td>5092.72</td>
<td>3182.21</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="code-14.52" class="level4">
<h4 class="anchored" data-anchor-id="code-14.52">Code 14.52</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T11:43:48.037125Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T11:43:48.036030Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T11:43:48.054587Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T11:43:48.053690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T11:43:48.037042Z&quot;}" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scale and reorder distance matrix</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>Dmat_ord <span class="op">=</span> (Dmat.loc[spp_obs, spp_obs] <span class="op">/</span> Dmat.loc[spp_obs, spp_obs].<span class="bu">max</span>()).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a good opportunity to show a use-case of PyMC’s GP module. In the Oceanic tools example above, we didn’t need a mean function (which means it was automatically set to 0 by PyMC). Now however, we need both a mean function <em>and</em> a covariance function to specify our GP. The covariance function will look familiar. For the mean function, we could use <code>gp.mean.Linear</code>, which takes as input a matrix of coefficients and a vector of intercepts. But that mean function would then be evaluated on our distance matrix, as <code>SIGMA</code> will be.</p>
<p>We don’t want that – we only want the mean function to depend on <code>M</code> and <code>G</code> not on the phylogenetic distance. We can easily <a href="https://docs.pymc.io/notebooks/GP-MeansAndCovs.html#Defining-a-custom-mean-function">define a custom mean function</a> in PyMC. We just need to subclass <code>pm.gp.mean.Mean</code> and provide <code>__call__</code> and <code>__init__</code> methods:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T11:46:35.561132Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T11:46:35.560612Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T11:46:35.567431Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T11:46:35.566303Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T11:46:35.561093Z&quot;}" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinearMean(pm.gp.mean.Mean):</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, intercept, slopes):</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.intercept <span class="op">=</span> intercept</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.slopes <span class="op">=</span> slopes</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, X):</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""In the trace summary, b0 will be bM and b1 will be bG"""</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.intercept <span class="op">+</span> <span class="va">self</span>.slopes[<span class="dv">0</span>] <span class="op">*</span> M <span class="op">+</span> <span class="va">self</span>.slopes[<span class="dv">1</span>] <span class="op">*</span> G</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can easily use this function in our model below. Notice we use <code>pm.gp.Marginal</code> and <code>gp.marginal_likelihood</code> instead of <code>pm.gp.Latent</code> and <code>gp.prior</code> as in the Oceanic tools example. It’s because here we have a (multivariate) normal likelihood, which works well analytically with a GP prior, so <code>Marginal</code> and <code>marginal_likelihood</code> just take advantage of the closed-form solution to speed-up computations. It’s also why you see no calls to <code>pm.MvNormal</code> below: this is implicit in <code>marginal_likelihood</code>, which evaluates the GP at the <code>X</code> points (<code>Dmat_ord</code>). And do you recall what the evaluation of a GP is? An MvNormal random variable – bingo!</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T11:50:11.837494Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T11:50:11.836443Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T12:06:03.709527Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T12:06:03.708408Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T11:50:11.837406Z&quot;}" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> m14_11:</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> pm.Normal(<span class="st">"a"</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> pm.Normal(<span class="st">"b"</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span>, shape<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specify the mean function:</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> LinearMean(intercept<span class="op">=</span>a, slopes<span class="op">=</span>b)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># half_normal(1, 0.25) is too strong</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    etasq <span class="op">=</span> pm.Exponential(<span class="st">"etasq"</span>, <span class="fl">1.0</span>)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    rhosq <span class="op">=</span> pm.Normal(<span class="st">"rhosq"</span>, <span class="fl">3.0</span>, <span class="fl">0.25</span>)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specify the covariance function:</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    SIGMA <span class="op">=</span> etasq <span class="op">*</span> pm.gp.cov.Exponential(input_dim<span class="op">=</span><span class="dv">1</span>, ls<span class="op">=</span>rhosq)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specify the GP:</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    gp <span class="op">=</span> pm.gp.Marginal(mean_func<span class="op">=</span>mu, cov_func<span class="op">=</span>SIGMA)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># place a GP prior over the observations.</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SIGMA will be conditioned on Dmat_ord.</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mu won't be, as we coded it on purpose.</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.Exponential(<span class="st">"sigma"</span>, <span class="fl">1.0</span>)</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> gp.marginal_likelihood(<span class="st">"B"</span>, X<span class="op">=</span>Dmat_ord, y<span class="op">=</span>B_, noise<span class="op">=</span>sigma)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">not</span> os.path.exists(<span class="st">'trace_14_11.nc'</span>)):</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>        trace_14_11 <span class="op">=</span> pm.sample(<span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, target_accept<span class="op">=</span><span class="fl">0.9</span>, random_seed<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>        az.InferenceData.to_netcdf(trace_14_11, <span class="st">'trace_14_11.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [a, b, etasq, rhosq, sigma]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="92" class="" max="16000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      0.57% [92/16000 14:30&lt;41:49:48 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: Not enough samples to build a trace.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>trace_14_11 <span class="op">=</span> az.from_netcdf(<span class="st">'trace_14_11.nc'</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="co"># b0 is bM and b1 is bG</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>az.summary(trace_14_11, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All the posteriors are looking good and similar to the book, except for <code>etasq</code>. If you replace <code>etasq = pm.Exponential('etasq', 1.0)</code> by <code>etasq = pm.Normal('etasq', 1.0, 0.25)</code>, you will see that this prior is too strong and is not moved by the data, which is why I changed it. Moreover, I don’t understand how the results for <code>etasq</code> reported in the book could be so close to 0 (<span class="math inline">\([0.03, 0.05]\)</span>), especially with a prior as strong as <code>half_normal(1, 0.25)</code>.</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(trace_14_11, compact<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-85-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="code-14.53" class="level4">
<h4 class="anchored" data-anchor-id="code-14.53">Code 14.53</h4>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>d_seq <span class="op">=</span> np.linspace(<span class="dv">0</span>, Dmat_ord.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>post <span class="op">=</span> trace_14_11.posterior.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>))</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co"># prior mean and 89% interval</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>eta <span class="op">=</span> np.random.exponential(<span class="fl">1.0</span>, <span class="dv">1000</span>)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>rho <span class="op">=</span> np.random.normal(<span class="fl">3.0</span>, <span class="fl">0.25</span>, <span class="dv">1000</span>)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> []</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> d_seq:</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    K.append(eta <span class="op">*</span> np.exp(<span class="op">-</span>rho <span class="op">*</span> d))</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> np.asarray(K)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>ax.plot(d_seq, K.mean(<span class="dv">1</span>), <span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(d_seq, K.T, color<span class="op">=</span><span class="st">"k"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>post_etasq <span class="op">=</span> post[<span class="st">"etasq"</span>][::<span class="dv">50</span>].values[:, <span class="va">None</span>]</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>post_rhosq <span class="op">=</span> post[<span class="st">"rhosq"</span>][::<span class="dv">50</span>].values[:, <span class="va">None</span>]</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>ax.plot(d_seq, (post_etasq <span class="op">*</span> np.exp(<span class="op">-</span>post_rhosq <span class="op">*</span> d_seq)).T, <span class="st">"b"</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"phylogenetic distance"</span>, ylabel<span class="op">=</span><span class="st">"covariance"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chp_14_Exercise_files/figure-html/cell-86-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-12-12T12:07:13.131625Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-12-12T12:07:13.130602Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-12-12T12:07:13.169717Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-12-12T12:07:13.168807Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-12-12T12:07:13.131546Z&quot;}" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">-</span>n <span class="op">-</span>u <span class="op">-</span>v <span class="op">-</span>iv <span class="op">-</span>w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Last updated: Tue Dec 12 2023

Python implementation: CPython
Python version       : 3.10.9
IPython version      : 8.11.0

pymc      : 4.3.0
pandas    : 1.5.3
numpy     : 1.24.2
aesara    : 2.8.7
matplotlib: 3.7.1
scipy     : 1.10.1
arviz     : 0.13.0

Watermark: 2.3.1
</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>